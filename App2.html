<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ernegy - Evaluación y Control de Proyectos de Energía</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #1a3a5f;          /* Azul oscuro profesional */
            --primary-light: #2c5aa0;    /* Azul medio */
            --accent: #e63946;           /* Rojo para alertas y énfasis */
            --success: #2a9d8f;          /* Verde esmeralda para éxito */
            --warning: #f4a261;          /* Naranja suave para advertencias */
            --light-bg: #f8f9fa;         /* Fondo claro */
            --light-card: #ffffff;       /* Blanco puro para tarjetas */
            --text-primary: #212529;     /* Texto oscuro */
            --text-secondary: #6c757d;   /* Texto secundario */
            --border: #e9ecef;           /* Borde suave */
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow: 0 4px 16px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
            --radius: 12px;              /* Bordes más suaves */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        html, body {
            height: 100%;
        }
        body {
            background-color: var(--light-bg);
            color: var(--text-primary);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding-top: 80px;
        }
        main {
            flex: 1;
        }
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }
        .container-full {
            width: 100%;
            padding: 0 24px;
        }
        /* Header Moderno */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, #122a44 100%);
            color: white;
            padding: 16px 0;
            box-shadow: var(--shadow-sm);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .logo h1 {
            font-size: 26px;
            font-weight: 700;
            letter-spacing: -0.5px;
            background: linear-gradient(to right, #ffffff, #a0c4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .logo-icon {
            font-size: 32px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        nav ul {
            display: flex;
            list-style: none;
            gap: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }
        nav a {
            color: rgba(255, 255, 255, 0.85);
            text-decoration: none;
            font-weight: 500;
            font-size: 15px;
            padding: 8px 16px;
            border-radius: 8px;
            transition: var(--transition);
            position: relative;
        }
        nav a:hover,
        nav a:focus {
            color: white;
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        nav a.active {
            color: white;
            background: rgba(255, 255, 255, 0.2);
            font-weight: 600;
        }
        /* Páginas y Contenedores */
        .page {
            display: none;
            padding: 2px 0;
        }
        .page.active {
            display: block;
        }
        .page-wrapper {
            display: flex;
            flex-direction: column;
            min-height: 100%;
        }
        .spacer {
            flex: 1;
        }
        /* Secciones Generales */
        .hero {
            background: linear-gradient(rgba(26, 58, 95, 0.7), rgba(26, 58, 95, 0.7)), url('https://images.unsplash.com/photo-1466611653911-95081537e5b7?ixlib=rb-4.0.3&auto=format&fit=crop&w=1400&q=80') center/cover no-repeat;
            color: white;
            text-align: center;
            padding: 80px 0;
            border-radius: var(--radius);
            margin-bottom: 40px;
            box-shadow: var(--shadow);
        }
        .hero h2 {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            letter-spacing: -1px;
        }
        .hero p {
            font-size: 20px;
            max-width: 720px;
            margin: 0 auto 32px;
            font-weight: 300;
            opacity: 0.9;
        }
        .cta-button {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary-light), #3a6ea5);
            color: white;
            padding: 16px 40px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            font-size: 18px;
            transition: var(--transition);
            box-shadow: var(--shadow);
            border: none;
            cursor: pointer;
            letter-spacing: 0.5px;
        }
        .cta-button:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: var(--shadow-lg);
            background: linear-gradient(135deg, #3a6ea5, var(--primary-light));
        }
        .section-title {
            text-align: center;
            margin-bottom: 48px;
        }
        .section-title h2 {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 16px;
            position: relative;
            display: inline-block;
            padding-bottom: 16px;
        }
        .section-title h2:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-light), var(--primary));
            border-radius: 2px;
        }
        .section-title p {
            color: var(--text-secondary);
            font-size: 18px;
            max-width: 600px;
            margin: 16px auto 0;
        }
        /* Cards y Grids */
        .services-grid,
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 32px;
            margin-bottom: 40px;
        }
        .service-card,
        .project-card {
            background: var(--light-card);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            border: 1px solid var(--border);
        }
        .service-card:hover,
        .project-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow);
            border-color: rgba(44, 90, 160, 0.3);
        }
        .service-icon {
            font-size: 56px;
            color: var(--primary-light);
            margin: 24px auto 16px;
            display: block;
        }
        .service-card h3,
        .project-content h3 {
            font-size: 22px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 16px;
            padding: 0 24px;
        }
        .service-card p,
        .project-content p {
            color: var(--text-secondary);
            margin: 0 24px 24px;
            line-height: 1.6;
        }
        .project-image {
            height: 200px;
            background-size: cover;
            background-position: center;
            background-color: var(--primary-light);
        }
        .project-link {
            display: inline-block;
            background: var(--primary-light);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            font-size: 15px;
            transition: var(--transition);
        }
        /* Tabla de evaluación */
        .evaluation-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            margin-bottom: 2px;
        }
        .evaluation-table th,
        .evaluation-table td {
            padding: 8px 12px; /* Altura más chica */
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .evaluation-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
            font-size: 16px;
        }
        .evaluation-table td:first-child {
            font-weight: 600;
            color: var(--primary);
            background: rgba(26, 58, 95, 0.02);
            width: 30%;
        }
        .evaluation-table input,
        .evaluation-table select,
        .evaluation-table textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: var(--transition);
        }
        .evaluation-table input:focus,
        .evaluation-table select:focus,
        .evaluation-table textarea:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.1);
        }
        .evaluation-table textarea {
            min-height: 60px;
            resize: vertical;
        }
        /* Layout de tablas lado a lado */
        .tables-container {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
        }
        .input-table-container {
            flex: 0 0 50%;
            width: 50%;
        }
        .results-table-container {
            flex: 0 0 50%;
            width: 50%;
        }

        @media (max-width: 768px) {
            .tables-container {
                flex-direction: column;
            }
        }
        .project-link:hover {
            background: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        /* Quote Section */
        .quote {
            background: linear-gradient(135deg, var(--primary-light) 0%, #1a3a5f 100%);
            color: white;
            padding: 60px 0;
            text-align: center;
            border-radius: var(--radius);
            margin: 40px 0;
            box-shadow: var(--shadow-sm);
        }
        .quote blockquote {
            font-size: 28px;
            font-style: italic;
            font-weight: 300;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.5;
            position: relative;
            padding: 0 40px;
        }
        .quote blockquote:before,
        .quote blockquote:after {
            content: '"';
            font-size: 60px;
            color: rgba(255,255,255,0.3);
            position: absolute;
        }
        .quote blockquote:before {
            top: -20px;
            left: 0;
        }
        .quote blockquote:after {
            bottom: -60px;
            right: 0;
        }
        .quote cite {
            display: block;
            margin-top: 24px;
            font-size: 18px;
            font-weight: 500;
            opacity: 0.9;
        }
        /* Footer */
        footer {
            background: var(--primary);
            color: rgba(255, 255, 255, 0.8);
            padding: 24px 0;
            font-size: 14px;
            text-align: center;
            margin-top: 40px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        /* Botones Modernos */
        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 15px;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            letter-spacing: 0.3px;
        }
        .btn i {
            font-size: 16px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-light), #1a3a5f);
            color: white;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #1a3a5f, var(--primary-light));
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        .btn-success {
            background: linear-gradient(135deg, var(--success), #227e74);
            color: white;
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #227e74, var(--success));
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        .btn-danger {
            background: linear-gradient(135deg, var(--accent), #b82b37);
            color: white;
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #b82b37, var(--accent));
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, #495057, #6c757d);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        /* Formularios y Controles */
        .form-group {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .form-group label {
            font-weight: 600;
            color: var(--primary);
            font-size: 15px;
            margin-bottom: 4px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            transition: var(--transition);
            background: var(--light-card);
            color: var(--text-primary);
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        /* Evaluation & Control Specific */
        .evaluation-control-container {
            display: flex;
            gap: 32px;
            margin-top: 24px;
            flex-wrap: wrap;
            width: 100%;
        }
        .projects-sidebar {
            width: 200px;
            background: var(--light-card);
            border-radius: 0;
            padding: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            border-left: none;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 999;
            flex-shrink: 0;
            overflow-y: auto;
            font-size: 12px;
        }
        @media (max-width: 768px) {
            .projects-sidebar {
                width: 100%;
                height: auto;
                position: relative;
                margin-top: 0;
            }
            .projects-sidebar h3 {
                margin-top: 0;
            }
            .form-container {
                margin-left: 0;
            }
        }
        .projects-sidebar h3 {
            color: var(--primary);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-light);
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 80px;
        }
        .projects-sidebar h3 i {
            color: var(--primary-light);
        }
        .project-list {
            list-style: none;
            max-height: 420px;
            overflow-y: auto;
            padding-right: 8px;
        }
        .project-list li {
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }
        .project-list li:before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--border);
            border-radius: 50%;
        }
        .project-list li:hover {
            background: rgba(44, 90, 160, 0.05);
            border-color: rgba(44, 90, 160, 0.2);
        }
        .project-list li.active {
            background: var(--primary-light);
            color: white;
            border-color: var(--primary-light);
        }
        .project-list li.active:before {
            background: white;
        }
        .form-container {
            flex: 1;
            background: var(--light-card);
            border-radius: var(--radius);
            padding: 8px 32px 32px 32px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin-left: 200px;
            width: calc(100% - 200px);
        }
        .results {
            padding: 24px;
            background: #f0f7ff;
            border-radius: var(--radius);
            border: 1px solid #c2e0ff;
            font-size: 16px;
            font-weight: 500;
            color: var(--primary);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .results p {
            margin: 8px 0;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .results p strong {
            font-weight: 600;
            color: var(--primary);
        }
        .chart-container {
            height: 320px;
            position: relative;
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid var(--border);
        }
        .buttons {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            padding-top: 16px;
            border-top: 2px dashed var(--border);
        }
        /* Progress Bars */
        .progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        .progress-item {
            background: var(--light-card);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            transition: var(--transition);
        }
        .progress-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
        }
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .progress-title {
            font-weight: 600;
            color: var(--primary);
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .progress-title i {
            color: var(--primary-light);
            font-size: 18px;
        }
        .progress-bar {
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-light), var(--primary));
            border-radius: 6px;
            transition: width 0.5s ease;
        }
        .progress-value {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: var(--text-secondary);
        }
        .progress-value input[type="number"] {
            width: 60px;
            text-align: center;
            font-weight: 600;
            color: var(--primary);
        }
        /* Gantt Chart */
        .gantt-container {
            margin-top: 8px;
            background: var(--light-card);
            padding: 32px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }
        .gantt-container h4 {
            color: var(--primary);
            margin-bottom: 24px;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .gantt-container h4 i {
            color: var(--primary-light);
        }
        .gantt-wrapper {
            display: flex;
            position: relative;
            gap: 16px;
        }
        .gantt-labels {
            width: 180px;
            flex-shrink: 0;
        }
        .gantt-label {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
            font-weight: 600;
            color: var(--primary);
            padding-left: 16px;
            font-size: 15px;
            border-bottom: 1px solid var(--border);
        }
        .gantt-chart {
            flex: 1;
            height: 240px;
            position: relative;
            border-left: 2px solid var(--border);
            border-bottom: 2px solid var(--border);
            background: #fafafa;
            border-radius: 0 8px 8px 0;
            overflow: hidden;
        }
        .gantt-item {
            position: absolute;
            height: 28px;
            /* --- MODIFICACIÓN: Fondo claro para la barra de duración total --- */
            background: #e9ecef; /* Gris claro */
            border: 1px solid #ced4da; /* Borde sutil */
            border-radius: 4px;
            top: 6px;
            transition: var(--transition);
        }
        .gantt-item.total {
            background: #e9ecef;
            border-color: #adb5bd;
        }
        .gantt-item:hover {
            transform: scaleY(1.1);
            z-index: 10;
        }
        .gantt-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            /* --- MODIFICACIÓN: Color azul para la barra de avance --- */
            background: var(--primary-light); /* Azul que destaca */
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        /* --- MODIFICACIÓN: Estilo para la etiqueta de porcentaje en negrita --- */
        .gantt-progress-label {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: 700; /* Negrita */
            color: #111;      /* Color negro */
            text-shadow: 0 0 2px rgba(0,0,0,0.5);
            z-index: 5;
        }
        .gantt-today-line {
            position: absolute;
            top: 0;
            width: 3px;
            height: 100%;
            background: var(--success);
            z-index: 5;
            box-shadow: 0 0 4px rgba(42, 157, 143, 0.5);
        }
        .gantt-current-line {
            position: absolute;
            top: 0;
            width: 3px;
            height: 100%;
            background: var(--accent);
            z-index: 5;
            box-shadow: 0 0 4px rgba(230, 57, 70, 0.5);
        }
        /* Contact Form */
        #contact-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 520px;
            margin: 0 auto;
        }
        #contact-form .btn {
            align-self: center;
            margin-top: 16px;
        }
        /* Error & Success Messages */
        .error-message {
            color: var(--accent);
            background: #fef2f2;
            border: 1px solid #fecaca;
            padding: 16px;
            border-radius: var(--radius);
            margin: 16px 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .error-message i {
            font-size: 20px;
        }
        .success-message {
            color: var(--success);
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            padding: 16px;
            border-radius: var(--radius);
            margin: 16px 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .success-message i {
            font-size: 20px;
        }
        /* Responsive Design */
        @media (max-width: 1024px) {
            .container {
                padding: 0 16px;
            }
            .hero {
                padding: 60px 0;
            }
            .hero h2 {
                font-size: 36px;
            }
            .section-title h2 {
                font-size: 32px;
            }
        }
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 16px;
            }
            nav ul {
                gap: 8px;
                justify-content: center;
            }
            .hero h2 {
                font-size: 32px;
            }
            .hero p {
                font-size: 18px;
                margin-bottom: 24px;
            }
            .evaluation-control-container {
                flex-direction: column;
            }
            .projects-sidebar {
                width: 100%;
            }
            .form-grid,
            .progress-grid {
                grid-template-columns: 1fr;
            }
            .gantt-wrapper {
                flex-direction: column;
            }
            .gantt-labels {
                width: 100%;
                border-bottom: 2px solid var(--border);
                padding-bottom: 16px;
                margin-bottom: 16px;
            }
            .gantt-label {
                justify-content: flex-start;
                padding-left: 16px;
                padding-right: 0;
            }
            .gantt-chart {
                border-radius: 8px;
                border-left: none;
            }
        }
        @media (max-width: 480px) {
            .hero {
                padding: 40px 0;
            }
            .hero h2 {
                font-size: 28px;
            }
            .section-title h2 {
                font-size: 28px;
            }
            .services-grid,
            .projects-grid {
                grid-template-columns: 1fr;
                gap: 24px;
            }
            .form-container {
                padding: 24px;
            }
            .buttons {
                flex-direction: column;
            }
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
        /* Control Table Styles */
        .control-table {
            width: 100%;
            border-collapse: collapse;
            margin: 2px 0;
            background: var(--light-card);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }
        .control-table th:first-child,
        .control-table td:first-child {
            text-align: left;
        }
        .control-table th:not(:first-child),
        .control-table td:not(:first-child) {
            text-align: center;
        }
        .control-table thead {
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: white;
        }
        .control-table th {
            padding: 8px 12px; /* Altura más chica */
            font-weight: 600;
            font-size: 15px;
            text-align: left;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }
        .control-table tbody tr {
            border-bottom: 1px solid #e3f2fd;
            transition: var(--transition);
        }
        .control-table tbody tr:nth-child(odd) {
            background: linear-gradient(90deg, #f8fbff 0%, #ffffff 100%);
        }
        .control-table tbody tr:nth-child(even) {
            background: linear-gradient(90deg, #f0f8ff 0%, #fafcff 100%);
        }
        .control-table tbody tr:hover {
            background: linear-gradient(90deg, #e3f2fd 0%, #f3f9ff 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(44, 90, 160, 0.1);
        }
        .control-table td {
            padding: 8px 12px; /* Altura más chica */
            vertical-align: top;
            border-right: 1px solid #e8f4fd;
        }
        .control-table td:last-child {
            border-right: none;
        }
        .hito-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--primary);
            font-size: 15px;
        }
        .hito-title i {
            color: var(--primary-light);
            font-size: 16px;
        }
        .date-inputs {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .date-inputs input[type="date"] {
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            background: white;
            transition: var(--transition);
        }
        .date-inputs input[type="date"]:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.1);
        }
        .progress-cell {
            text-align: center;
        }
        .progress-cell input[type="number"] {
            width: 70px;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
            color: var(--primary);
            background: white;
            transition: var(--transition);
        }
        .progress-cell input[type="number"]:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.1);
        }
        .comments-cell {
            max-width: none;
            vertical-align: stretch;
            padding: 0;
        }
        .comments-row {
            display: flex;
            align-items: stretch;
            gap: 4px;
            flex-wrap: nowrap;
            height: 80px;
            padding: 8px;
        }
        .comments-history {
            height: 64px;
            overflow: hidden;
            padding: 4px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 12px;
            width: 120px;
            position: relative;
            flex-shrink: 0;
        }
        .comments-nav {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex-shrink: 0;
            height: 100%;
            justify-content: center;
        }
        .btn-nav-comment {
            width: 16px;
            height: 16px;
            border: none;
            background: var(--primary-light);
            color: white;
            border-radius: 2px;
            cursor: pointer;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-nav-comment:hover {
            background: var(--primary);
        }
        .comment-item {
            background: white;
            padding: 6px 8px;
            margin-bottom: 4px;
            border-radius: 4px;
            border-left: 3px solid var(--primary-light);
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .comment-date {
            font-size: 10px;
            color: var(--text-secondary);
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .comment-text {
            font-size: 12px;
            line-height: 1.3;
            cursor: pointer;
            flex: 1;
            padding-right: 20px;
        }
        .comment-text:hover {
            background: #f0f8ff;
        }
        .comment-actions {
            position: absolute;
            top: 2px;
            right: 4px;
        }
        .btn-delete-comment {
            width: 16px;
            height: 16px;
            border: none;
            background: var(--accent);
            color: white;
            border-radius: 2px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-delete-comment:hover {
            background: #b82b37;
        }
        .comment-edit-input {
            width: 100%;
            padding: 2px 4px;
            border: 1px solid var(--primary-light);
            border-radius: 2px;
            font-size: 12px;
            font-family: inherit;
        }
        .comments-row textarea {
            flex: 1;
            height: 64px;
            padding: 6px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
            resize: none;
            background: white;
            transition: var(--transition);
            margin-right: 4px;
        }
        .comments-row textarea:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.1);
        }
        .comments-row textarea::placeholder {
            color: var(--text-secondary);
            font-style: italic;
        }
        .btn-add-comment {
            width: 24px;
            height: 64px;
            border: none;
            background: var(--primary-light);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            flex-shrink: 0;
        }
        .btn-add-comment:hover {
            background: var(--primary);
            transform: scale(1.1);
        }
        /* Modal de comentarios */
        .comments-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .comments-modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
        }
        .btn-close-modal {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
        }
        .btn-close-modal:hover {
            color: var(--accent);
        }
        .modal-comments-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .modal-comment-item {
            background: white;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid var(--primary-light);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .modal-comment-date {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .modal-comment-text {
            font-size: 14px;
            line-height: 1.4;
            flex: 1;
        }
        .modal-new-comment {
            border-top: 2px solid var(--border);
            padding-top: 16px;
        }
        .modal-layout {
            display: flex;
            gap: 20px;
            height: 300px;
        }
        .modal-left-panel {
            flex: 1;
            border-right: 2px solid var(--border);
            padding-right: 20px;
        }
        .modal-right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .modal-left-panel h4,
        .modal-right-panel h4 {
            color: var(--primary);
            margin-bottom: 12px;
            font-size: 16px;
        }
        #modal-comments-sidebar {
            max-height: 220px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
            background: #f8f9fa;
        }
        .selectable-comment {
            cursor: pointer;
            transition: var(--transition);
        }
        .selectable-comment:hover {
            background: #e3f2fd;
        }
        .selectable-comment.selected {
            background: var(--primary-light);
            color: white;
        }
        .modal-new-comment textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 12px;
            flex: 1;
        }
        .modal-new-comment textarea:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.1);
        }
        .modal-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-start;
        }
        .modal-buttons .btn {
            padding: 8px 16px;
            font-size: 14px;
        }
        .btn-view-comments {
            width: 20px;
            height: 64px;
            border: none;
            background: var(--success);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .btn-view-comments:hover {
            background: #227e74;
        }
        /* --- INICIO: Estilos para tabla de reporte compacta --- */
        .report-table-compact {
            table-layout: fixed; /* Fija el ancho de las columnas */
            width: 100%; /* Usa todo el ancho disponible */
            font-size: 13px; /* Texto más pequeño */
        }
        .report-table-compact th,
        .report-table-compact td {
            white-space: nowrap; /* Evita que el texto se divida en varias líneas */
            padding: 6px 8px; /* Padding más pequeño */
            overflow: hidden; /* Oculta contenido que se desborde */
            text-overflow: ellipsis; /* Añade ... si el texto es muy largo */
        }
        .report-table-compact th:first-child,
        .report-table-compact td:first-child {
            text-align: left; /* Primera columna alineada a la izquierda */
            width: 15%; /* Ancho fijo para la primera columna */
        }
        .report-table-compact th:not(:first-child),
        .report-table-compact td:not(:first-child) {
            text-align: center; /* Columnas 2 en adelante centradas */
            width: auto; /* Ancho automático para el resto */
        }
        /* --- FIN: Estilos para tabla de reporte compacta --- */

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .page.active {
            animation: fadeInUp 0.6s ease-out;
        }
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, #122a44 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .login-container {
            width: 100%;
            max-width: 400px;
            padding: 24px;
        }
        .login-card {
            background: var(--light-card);
            border-radius: var(--radius);
            padding: 40px;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }
        .login-header h2 {
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 28px;
        }
        .login-header p {
            color: var(--text-secondary);
            margin-bottom: 32px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-bolt logo-icon"></i>
                    <h1>Ernegy</h1>
                </div>
                <nav>
                    <ul>
                        <li><a href="#" onclick="showPage('inicio'); return false;">Inicio</a></li>
                        <li><a href="#" onclick="showPage('servicios'); return false;">Servicios</a></li>
                        <li><a href="#" onclick="showPage('proyectos'); return false;">Proyectos</a></li>
                        <li><a href="#" onclick="showPage('evaluacion'); return false;">Evaluación</a></li>
                        <li><a href="#" onclick="showPage('control'); return false;">Control</a></li>
                        <li><a href="#" onclick="showPage('reporte'); return false;">Reporte</a></li>
                        <li><a href="#" onclick="showPage('contacto'); return false;">Contacto</a></li>
                        <li><a href="#" onclick="logout(); return false;" style="color: #f4a261;"><i class="fas fa-sign-out-alt"></i> Salir</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>
    <!-- PANTALLA DE LOGIN -->
    <div id="login-screen" class="login-screen">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <i class="fas fa-bolt" style="font-size: 48px; color: var(--primary-light); margin-bottom: 16px;"></i>
                    <h2>Ernegy</h2>
                    <p>Acceso al Sistema</p>
                </div>
                <form id="login-form">
                    <div class="form-group">
                        <label for="username">Usuario</label>
                        <input type="text" id="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Contraseña</label>
                        <input type="password" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-sign-in-alt"></i> Ingresar
                    </button>
                </form>
                <div id="login-error" style="display: none;"></div>
            </div>
        </div>
    </div>
    <main id="main-app" style="display: none;">
        <!-- PÁGINA DE INICIO -->
        <div id="inicio" class="page active">
            <div class="page-wrapper">
                <section class="hero">
                    <div class="container">
                        <h2>Herramienta de Evaluación y Control</h2>
                        <p>Plataforma integral para gestionar y maximizar el valor de tus proyectos energéticos</p>
                        <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                            <a href="#" onclick="showPage('evaluacion'); return false;" class="cta-button">
                                <i class="fas fa-calculator"></i> Evaluar Proyecto
                            </a>
                            <a href="#" onclick="showPage('control'); return false;" class="cta-button">
                                <i class="fas fa-chart-line"></i> Control Proyecto
                            </a>
                        </div>
                    </div>
                </section>
                <section class="quote">
                    <div class="container">
                        <blockquote>
                            "Lo que no se mide, no se puede mejorar. Lo que no se controla, no se puede gestionar."
                        </blockquote>
                        <cite>- Filosofía de Ernegy</cite>
                    </div>
                </section>
                <div class="spacer"></div>
            </div>
        </div>
        <!-- PÁGINA DE SERVICIOS -->
        <div id="servicios" class="page">
            <div class="page-wrapper">
                <div class="container">
                    <div class="section-title">
                        <h2>Nuestros Servicios</h2>
                        <p>Soluciones integrales para la gestión de proyectos energéticos</p>
                    </div>
                    <div class="services-grid">
                        <div class="service-card">
                            <i class="fas fa-plus-circle service-icon"></i>
                            <h3>Compra de Proyectos</h3>
                            <p>Adquisición estratégica de proyectos energéticos con alto potencial de rentabilidad y crecimiento sostenible.</p>
                            <a href="#" class="project-link">Más información</a>
                        </div>
                        <div class="service-card">
                            <i class="fas fa-solar-panel service-icon"></i>
                            <h3>Nuevos Proyectos</h3>
                            <p>Desarrollo de iniciativas innovadoras en energía renovable y convencional, con enfoque en sostenibilidad.</p>
                            <a href="#" class="project-link">Más información</a>
                        </div>
                        <div class="service-card">
                            <i class="fas fa-building service-icon"></i>
                            <h3>Proyectos Propios</h3>
                            <p>Gestión integral y optimización de proyectos de energía de cartera propia para maximizar su valor.</p>
                            <a href="#" class="project-link">Más información</a>
                        </div>
                        <div class="service-card">
                            <i class="fas fa-chart-line service-icon"></i>
                            <h3>Control del Desarrollo</h3>
                            <p>Seguimiento continuo y en tiempo real del avance y desempeño de todos tus proyectos energéticos.</p>
                            <a href="#" class="project-link">Más información</a>
                        </div>
                        <div class="service-card">
                            <i class="fas fa-file-alt service-icon"></i>
                            <h3>Reportes Detallados</h3>
                            <p>Generación de informes exhaustivos y personalizados para una toma de decisiones informada y estratégica.</p>
                            <a href="#" class="project-link">Más información</a>
                        </div>
                        <div class="service-card">
                            <i class="fas fa-cogs service-icon"></i>
                            <h3>Gestión de Valor</h3>
                            <p>Maximización del valor de los proyectos mediante estrategias de control y optimización efectivas.</p>
                            <a href="#" class="project-link">Más información</a>
                        </div>
                    </div>
                </div>
                <div class="spacer"></div>
            </div>
        </div>
        <!-- PÁGINA DE PROYECTOS -->
        <div id="proyectos" class="page">
            <div class="page-wrapper">
                <div class="container">
                    <div class="section-title">
                        <h2>Nuestros Proyectos</h2>
                        <p>Proyectos destacados que hemos desarrollado y gestionado con éxito</p>
                    </div>
                    <div class="projects-grid">
                        <div class="project-card">
                            <div class="project-image" style="background-color: #3498db;"></div>
                            <div class="project-content">
                                <h3>Parque Solar Valle Verde</h3>
                                <p>Instalación de 50MW de capacidad solar fotovoltaica en terrenos recuperados, con impacto ambiental positivo.</p>
                                <a href="#" class="project-link">Ver detalles</a>
                            </div>
                        </div>
                        <div class="project-card">
                            <div class="project-image" style="background-color: #2c3e50;"></div>
                            <div class="project-content">
                                <h3>Parque Eólico Costa Norte</h3>
                                <p>Desarrollo de 30 turbinas eólicas con capacidad total de 90MW, aprovechando los vientos costeros.</p>
                                <a href="#" class="project-link">Ver detalles</a>
                            </div>
                        </div>
                        <div class="project-card">
                            <div class="project-image" style="background-color: #e74c3c;"></div>
                            <div class="project-content">
                                <h3>Central Hidroeléctrica Río Azul</h3>
                                <p>Modernización de infraestructura hidroeléctrica con aumento del 40% en eficiencia y menor impacto ambiental.</p>
                                <a href="#" class="project-link">Ver detalles</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="spacer"></div>
            </div>
        </div>
        <!-- PÁGINA DE REPORTE -->
        <div id="reporte" class="page">
            <div class="page-wrapper">
                <div class="container">
                    <div style="background: var(--light-card); padding: 40px; border-radius: var(--radius); box-shadow: var(--shadow-sm); border: 1px solid var(--border);">
                        <h3 style="color: var(--primary); margin-bottom: 8px; margin-top: 0;"><i class="fas fa-chart-bar"></i> Generador de Reportes</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: flex-end; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; width: 100%; gap: 16px; margin-top: 0;">
                                <label for="tipo-reporte" style="font-weight: 600; color: var(--primary); min-width: 90px;">Reporte</label>
                                <select id="tipo-reporte" style="width: 220px; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                                    <option value="control-general">Control de todos los proyectos</option>
                                    <option value="control-proyecto">Control por proyecto</option>
                                    <option value="eval-proyecto">Evaluación por proyecto</option>
                                    <option value="eval-varios">Evaluaciones de varios proyectos</option>
                                </select>
                                <div id="selector-proyecto" style="display:none;">
                                    <select id="reporte-proyecto" style="width: 180px; padding: 10px; border: 1px solid var(--border); border-radius: 8px;"></select>
                                </div>
                                <div id="selector-varios" style="display:none;">
                                    <select id="reporte-varios" multiple style="width: 180px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; height: 80px;"></select>
                                </div>
                                <button class="btn btn-primary" id="generar-reporte" style="height: 44px; margin-left: 16px;">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-success" id="descargar-pptx" style="height: 44px; margin-left: 8px;">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                        <div id="reporte-resultado" style="margin-top: 32px;"></div>
                    </div>
                </div>
                <div class="spacer"></div>
            </div>
        </div>
        <!-- PÁGINA DE CONTACTO -->
        <div id="contacto" class="page">
            <div class="page-wrapper">
                <div class="container">
                    <div class="section-title">
                        <h2>Contáctanos</h2>
                        <p>Estamos aquí para ayudarte a llevar tus proyectos energéticos al siguiente nivel</p>
                    </div>
                    <div style="max-width: 800px; margin: 0 auto;">
                        <div style="background: var(--light-card); padding: 40px; border-radius: var(--radius); box-shadow: var(--shadow-sm); margin-bottom: 40px; border: 1px solid var(--border);">
                            <h3 style="font-size: 24px; margin-bottom: 24px; color: var(--primary); display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-info-circle"></i> Información de Contacto
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: 16px; text-align: left; max-width: 500px; margin: 0 auto;">
                                <p><i class="fas fa-map-marker-alt" style="color: var(--primary-light); margin-right: 12px;"></i> <strong>Dirección:</strong> Av. Energía 123, Ciudad Energética</p>
                                <p><i class="fas fa-phone" style="color: var(--primary-light); margin-right: 12px;"></i> <strong>Teléfono:</strong> +123 456 7890</p>
                                <p><i class="fas fa-envelope" style="color: var(--primary-light); margin-right: 12px;"></i> <strong>Email:</strong> info@energia03.com</p>
                                <p><i class="fas fa-clock" style="color: var(--primary-light); margin-right: 12px;"></i> <strong>Horario:</strong> Lunes a Viernes: 9:00 - 18:00</p>
                            </div>
                        </div>
                        <div style="background: var(--light-card); padding: 40px; border-radius: var(--radius); box-shadow: var(--shadow-sm); border: 1px solid var(--border);">
                            <h3 style="font-size: 24px; margin-bottom: 24px; color: var(--primary); display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-envelope"></i> Formulario de Contacto
                            </h3>
                            <form id="contact-form">
                                <div class="form-group">
                                    <label for="contact-name">Nombre completo</label>
                                    <input type="text" id="contact-name" placeholder="Ingresa tu nombre completo" required>
                                </div>
                                <div class="form-group">
                                    <label for="contact-email">Correo electrónico</label>
                                    <input type="email" id="contact-email" placeholder="Ingresa tu correo electrónico" required>
                                </div>
                                <div class="form-group">
                                    <label for="contact-subject">Asunto</label>
                                    <input type="text" id="contact-subject" placeholder="¿Sobre qué deseas contactarnos?" required>
                                </div>
                                <div class="form-group">
                                    <label for="contact-message">Mensaje</label>
                                    <textarea id="contact-message" placeholder="Cuéntanos cómo podemos ayudarte..." rows="5" style="resize: vertical;" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> Enviar Mensaje
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="spacer"></div>
            </div>
        </div>
        <!-- PÁGINA DE EVALUACIÓN -->
        <div id="evaluacion" class="page">
            <div class="page-wrapper" style="padding-top: 0;">
                <div class="container-full" style="padding-top: 0;">
                    <div class="evaluation-control-container">
                        <aside class="projects-sidebar">
                            <h3><i class="fas fa-folder"></i> Proyectos</h3>
                            <ul class="project-list" id="eval-project-list"></ul>
                        </aside>
                        <div class="form-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px;">
                                <h2 style="font-size: 24px; color: var(--primary); margin: 0;"><i class="fas fa-calculator"></i> Evaluación de Proyectos</h2>
                                <div style="display: flex; gap: 16px;">
                                    <button class="btn btn-primary" onclick="calculateEval()">
                                        <i class="fas fa-calculator"></i> Evaluar
                                    </button>
                                    <button class="btn btn-success" onclick="saveEvalProject()">
                                        <i class="fas fa-save"></i> Guardar
                                    </button>
                                    <button class="btn btn-secondary" onclick="editEvalProject()">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteEvalProject()">
                                        <i class="fas fa-trash"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                            <div class="tables-container">
                                <div class="input-table-container">
                                    <form id="eval-form">
                                        <table class="evaluation-table">
                                            <thead>
                                                <tr>
                                                    <th>Campo</th>
                                                    <th>Características a Completar</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td><i class="fas fa-tag"></i> Nombre</td>
                                                    <td><input type="text" id="eval-name" placeholder="Nombre del proyecto" required></td>
                                                </tr>
                                                <tr>
                                                    <td><i class="fas fa-map-marker-alt"></i> Ubicación</td>
                                                    <td><input type="text" id="eval-location" placeholder="Ubicación del proyecto" required></td>
                                                </tr>
                                                <tr>
                                                    <td><i class="fas fa-cogs"></i> Tecnología</td>
                                                    <td>
                                                        <select id="eval-tech" required>
                                                            <option value="">Selecciona una tecnología</option>
                                                            <option value="Solar">Solar Fotovoltaica</option>
                                                            <option value="Eólica">Eólica</option>
                                                            <option value="Hidroeléctrica">Hidroeléctrica</option>
                                                            <option value="Biomasa">Biomasa</option>
                                                            <option value="Geotérmica">Geotérmica</option>
                                                        </select>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td><i class="fas fa-dollar-sign"></i> Capex (mUSD)</td>
                                                    <td><input type="number" id="eval-capex" min="0" step="0.01" placeholder="Costo de inversión inicial" required></td>
                                                </tr>
                                                <tr>
                                                    <td><i class="fas fa-chart-line"></i> Opex (mUSD/año)</td>
                                                    <td><input type="number" id="eval-opex" min="0" step="0.01" placeholder="Costos operativos anuales" required></td>
                                                </tr>
                                                <tr>
                                                    <td><i class="fas fa-bolt"></i> Precio Energía (USD/MWh)</td>
                                                    <td><input type="number" id="eval-price" min="0" step="0.01" placeholder="Precio de venta de energía" required></td>
                                                </tr>
                                                <tr>
                                                    <td><i class="fas fa-calendar-alt"></i> Plazo de Evaluación (años)</td>
                                                    <td><input type="number" id="eval-period" min="1" step="1" placeholder="Horizonte de evaluación" required></td>
                                                </tr>
                                                <tr>
                                                    <td><i class="fas fa-percentage"></i> Tasa de Descuento (%)</td>
                                                    <td><input type="number" id="eval-discount" min="0" step="0.01" placeholder="Tasa de descuento" required></td>
                                                </tr>
                                                <tr>
                                                    <td><i class="fas fa-industry"></i> Producción Anual (MWh)</td>
                                                    <td><input type="number" id="eval-production" min="0" step="0.01" placeholder="Producción estimada anual" required></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </form>
                                </div>
                                <div class="results-table-container">
                                    <table class="evaluation-table" id="eval-results-table">
                                        <thead>
                                            <tr>
                                                <th>Indicador Financiero</th>
                                                <th>Resultado</th>
                                            </tr>
                                        </thead>
                                        <tbody id="eval-results">
                                            <tr>
                                                <td colspan="2" style="text-align: center; color: var(--text-secondary); font-style: italic;">
                                                    Completa el formulario y haz clic en "Evaluar" para ver los resultados
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div class="chart-container">
                                        <canvas id="cashflow-chart"></canvas>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="spacer"></div>
            </div>
        </div>
        <!-- PÁGINA DE CONTROL -->
        <div id="control" class="page">
            <div class="page-wrapper" style="padding-top: 0;">
                <div class="container-full" style="padding-top: 0;">
                    <div class="evaluation-control-container">
                        <div class="projects-sidebar">
                            <h3><i class="fas fa-folder"></i> Proyectos</h3>
                            <ul class="project-list" id="control-project-list"></ul>

                        </div>
                        <div class="form-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px;">
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <label style="font-weight: 600; color: var(--primary);">Nombre:</label>
                                    <input type="text" id="control-project-name-header" placeholder="Nombre del proyecto" style="padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 16px; min-width: 200px;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <label style="font-weight: 600; color: var(--primary);">Fecha Control:</label>
                                    <input type="date" id="control-date" style="padding: 8px; border: 1px solid var(--border); border-radius: 6px;">
                                    <button class="btn btn-success" onclick="saveControlProject()">
                                        <i class="fas fa-save"></i> Guardar
                                    </button>
                                    <button class="btn btn-secondary" onclick="editControlProject()">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteControlProject()">
                                        <i class="fas fa-trash"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                            <!-- --- INICIO: Nueva Tabla de Control --- -->
                            <table class="control-table">
                                <thead>
                                    <tr>
                                        <th style="width: 15%;">Hito</th>
                                        <th style="width: 15%; text-align: center;">Fechas (Inicio/Fin)</th>
                                        <th style="width: 15%; text-align: center;">Estado (%)</th>
                                        <th style="width: 55%;">Comentarios</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Fecha de Inicio -->
                                    <tr>
                                        <td><div class="hito-title"><i class="fas fa-calendar-day"></i> Fecha de Inicio</div></td>
                                        <td>
                                            <div class="date-inputs">
                                               <input type="date" id="proyecto-start" onchange="updateGanttChart()">
                                            </div>
                                        </td>
                                        <td class="progress-cell"></td>
                                        <td class="comments-cell"></td>
                                    </tr>
                                    <!-- Terreno -->
                                    <tr>
                                        <td><div class="hito-title"><i class="fas fa-landmark"></i> Terreno</div></td>
                                        <td>
                                            <div class="date-inputs">
                                               <input type="date" id="terreno-start" onchange="updateGanttChart()">
                                                <input type="date" id="terreno-end" onchange="updateGanttChart()">
                                            </div>
                                        </td>
                                        <td class="progress-cell">
                                            <input type="number" id="terreno-progress" min="0" max="100" value="0" oninput="updateProgress('terreno', this.value)">
                                        </td>
                                        <td class="comments-cell">
                                            <div class="comments-row">
                                                <textarea id="terreno-comments" placeholder="Añadir nuevo comentario..." rows="2"></textarea>
                                                <button class="btn-view-comments" onclick="openCommentsModal('terreno', 'history')" title="Ver comentarios"><i class="fas fa-eye"></i></button>
                                                <button class="btn-view-comments" onclick="openCommentsModal('terreno', 'new')" title="Escribir comentario"><i class="fas fa-edit"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Conexión -->
                                    <tr>
                                        <td><div class="hito-title"><i class="fas fa-plug"></i> Conexión</div></td>
                                        <td>
                                            <div class="date-inputs">
                                                <input type="date" id="conexion-start" onchange="updateGanttChart()">
                                                <input type="date" id="conexion-end" onchange="updateGanttChart()">
                                            </div>
                                        </td>
                                        <td class="progress-cell">
                                            <input type="number" id="conexion-progress" min="0" max="100" value="0" oninput="updateProgress('conexion', this.value)">
                                        </td>
                                        <td class="comments-cell">
                                            <div class="comments-row">
                                                <textarea id="conexion-comments" placeholder="Añadir nuevo comentario..." rows="2"></textarea>
                                                <button class="btn-view-comments" onclick="openCommentsModal('conexion', 'history')" title="Ver comentarios"><i class="fas fa-eye"></i></button>
                                                <button class="btn-view-comments" onclick="openCommentsModal('conexion', 'new')" title="Escribir comentario"><i class="fas fa-edit"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Línea -->
                                    <tr>
                                        <td><div class="hito-title"><i class="fas fa-route"></i> Línea</div></td>
                                        <td>
                                            <div class="date-inputs">
                                                <input type="date" id="linea-start" onchange="updateGanttChart()">
                                                <input type="date" id="linea-end" onchange="updateGanttChart()">
                                            </div>
                                        </td>
                                        <td class="progress-cell">
                                            <input type="number" id="linea-progress" min="0" max="100" value="0" oninput="updateProgress('linea', this.value)">
                                        </td>
                                        <td class="comments-cell">
                                            <div class="comments-row">
                                                <textarea id="linea-comments" placeholder="Añadir nuevo comentario..." rows="2"></textarea>
                                                <button class="btn-view-comments" onclick="openCommentsModal('linea', 'history')" title="Ver comentarios"><i class="fas fa-eye"></i></button>
                                                <button class="btn-view-comments" onclick="openCommentsModal('linea', 'new')" title="Escribir comentario"><i class="fas fa-edit"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Permiso Ambiental -->
                                    <tr>
                                        <td><div class="hito-title"><i class="fas fa-tree"></i> Permiso Ambiental</div></td>
                                        <td>
                                            <div class="date-inputs">
                                                <input type="date" id="permiso-start" onchange="updateGanttChart()">
                                                <input type="date" id="permiso-end" onchange="updateGanttChart()">
                                            </div>
                                        </td>
                                        <td class="progress-cell">
                                            <input type="number" id="permiso-progress" min="0" max="100" value="0" oninput="updateProgress('permiso', this.value)">
                                        </td>
                                        <td class="comments-cell">
                                            <div class="comments-row">
                                                <textarea id="permiso-comments" placeholder="Añadir nuevo comentario..." rows="2"></textarea>
                                                <button class="btn-view-comments" onclick="openCommentsModal('permiso', 'history')" title="Ver comentarios"><i class="fas fa-eye"></i></button>
                                                <button class="btn-view-comments" onclick="openCommentsModal('permiso', 'new')" title="Escribir comentario"><i class="fas fa-edit"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Comunidades -->
                                    <tr>
                                        <td><div class="hito-title"><i class="fas fa-users"></i> Comunidades</div></td>
                                        <td>
                                            <div class="date-inputs">
                                                <input type="date" id="comunidades-start" onchange="updateGanttChart()">
                                                <input type="date" id="comunidades-end" onchange="updateGanttChart()">
                                            </div>
                                        </td>
                                        <td class="progress-cell">
                                            <input type="number" id="comunidades-progress" min="0" max="100" value="0" oninput="updateProgress('comunidades', this.value)">
                                        </td>
                                        <td class="comments-cell">
                                            <div class="comments-row">
                                                <textarea id="comunidades-comments" placeholder="Añadir nuevo comentario..." rows="2"></textarea>
                                                <button class="btn-view-comments" onclick="openCommentsModal('comunidades', 'history')" title="Ver comentarios"><i class="fas fa-eye"></i></button>
                                                <button class="btn-view-comments" onclick="openCommentsModal('comunidades', 'new')" title="Escribir comentario"><i class="fas fa-edit"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <!-- --- FIN: Nueva Tabla de Control --- -->

                            <div class="gantt-container">
                                <h4><i class="fas fa-chart-gantt"></i> Cronograma - Diagrama de Gantt</h4>
                                <div class="gantt-wrapper">
                                    <div class="gantt-labels" id="gantt-labels"></div>
                                    <div class="gantt-chart" id="gantt-chart"></div>
                                </div>
                                <div id="gantt-dates" style="height: 30px; position: relative; margin-left: 180px; border-top: 1px solid #e9ecef; background: #f8f9fa;"></div>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="spacer"></div>
            </div>
        </div>
    </main>
    <!-- Modal de comentarios -->
    <div id="comments-modal" class="comments-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Comentarios</h3>
                <button class="btn-close-modal" onclick="closeCommentsModal()">&times;</button>
            </div>
            <div class="modal-comments-list" id="modal-comments-list"></div>
            <div class="modal-new-comment" id="modal-new-comment">
                <div class="modal-layout">
                    <div class="modal-left-panel" id="modal-left-panel">
                        <h4>Comentarios Anteriores</h4>
                        <div id="modal-comments-sidebar"></div>
                    </div>
                    <div class="modal-right-panel">
                        <h4>Nuevo Comentario</h4>
                        <textarea id="modal-textarea" placeholder="Escribir nuevo comentario..."></textarea>
                        <div class="modal-buttons">
                            <button class="btn btn-success" onclick="addModalComment()">Agregar</button>
                            <button class="btn btn-danger" onclick="deleteSelectedComment()" id="btn-delete-comment" disabled>Borrar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer>
        <div class="container">
            © 2025 Ernegy - Todos los derechos reservados
        </div>
    </footer>
    <script>
        // Configuración de Supabase
        const supabaseUrl = 'https://qjfmrcgtpkepnhvzeqmf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqZm1yY2d0cGtlcG5odnplcW1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5Njk0NDUsImV4cCI6MjA3MzU0NTQ0NX0.4n7YSN2IeFG9ElEqFO6C-Bhq7Ss3Gk5spUODR5ZKQHM';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Inicializar base de datos con creación automática
        async function initDatabase() {
            try {
                // Intentar insertar un registro de prueba para forzar la creación de tablas
                const testProject = {
                    name: '_test_project_delete_me',
                    location: 'test',
                    tech: 'test',
                    capex: 0,
                    opex: 0,
                    price: 0,
                    period: 1,
                    discount: 0,
                    production: 0
                };
                
                // Si la tabla no existe, Supabase la creará automáticamente
                const { data, error } = await supabase
                    .from('eval_projects')
                    .insert([testProject])
                    .select();
                
                if (!error && data) {
                    // Eliminar el proyecto de prueba
                    await supabase
                        .from('eval_projects')
                        .delete()
                        .eq('name', '_test_project_delete_me');
                    
                    showNotification('Tablas creadas y verificadas en Supabase', 'success');
                } else {
                    throw error;
                }
            } catch (error) {
                console.log('Error con Supabase:', error);
                // Verificar si las tablas existen
                try {
                    const { data } = await supabase.from('eval_projects').select('id').limit(1);
                    showNotification('Conectado a Supabase exitosamente', 'success');
                } catch (verifyError) {
                    showNotification('Usando almacenamiento local', 'info');
                }
            }
        }

        // Sistema de login
        function login(username, password) {
            if (username === 'Usuario5' && password === 'Calama5') {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                initDatabase();
                showNotification('Bienvenido al sistema', 'success');
                return true;
            } else {
                const errorDiv = document.getElementById('login-error');
                errorDiv.className = 'error-message';
                errorDiv.style.display = 'block';
                errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Usuario o contraseña incorrectos';
                return false;
            }
        }

        function logout() {
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('login-form').reset();
            document.getElementById('login-error').style.display = 'none';
            showNotification('Sesión cerrada', 'success');
        }

// --- Reporte dinámico ---
document.addEventListener('DOMContentLoaded', function() {
    const tipoReporte = document.getElementById('tipo-reporte');
    const selectorProyecto = document.getElementById('selector-proyecto');
    const selectorVarios = document.getElementById('selector-varios');
    const selectProyecto = document.getElementById('reporte-proyecto');
    const selectVarios = document.getElementById('reporte-varios');
    const btnGenerar = document.getElementById('generar-reporte');
    const resultado = document.getElementById('reporte-resultado');

    // --- INICIO: Añadido para descarga CSV ---
    const btnDescargar = document.getElementById('descargar-pptx');
    let currentReportDataForCSV = null;
    // --- FIN: Añadido para descarga CSV ---

    function getEvalProjects() {
        return JSON.parse(safeStorage.getItem('evalProjects') || '[]');
    }
    function getControlProjects() {
        return JSON.parse(safeStorage.getItem('controlProjects') || '[]');
    }

    function renderProyectoOptions(select, projects) {
        select.innerHTML = '';
        projects.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id || p.name;
            opt.textContent = p.name || 'Proyecto sin nombre';
            select.appendChild(opt);
        });
        console.log('Opciones renderizadas:', projects.length, 'proyectos'); // Debug
    }

    tipoReporte.addEventListener('change', function() {
        selectorProyecto.style.display = 'none';
        selectorVarios.style.display = 'none';
        if (this.value === 'control-proyecto') {
            selectorProyecto.style.display = '';
            renderProyectoOptions(selectProyecto, getControlProjects());
        } else if (this.value === 'eval-proyecto') {
            selectorProyecto.style.display = '';
            renderProyectoOptions(selectProyecto, getEvalProjects());
        } else if (this.value === 'eval-varios') {
            selectorVarios.style.display = '';
            renderProyectoOptions(selectVarios, getEvalProjects());
        }
    });

    btnGenerar.addEventListener('click', function() {
        let html = '';
        currentReportDataForCSV = null; // Reset CSV data
        resultado.innerHTML = ''; // Limpiar resultados anteriores

        if (tipoReporte.value === 'control-general') {
            const projects = getControlProjects();
            const reportData = [];

            projects.forEach(p => {
                const sortedControls = (p.controls || []).sort((a, b) => new Date(b.controlDate) - new Date(a.controlDate));
                let last = sortedControls.length > 0 ? sortedControls[0] : {};
                const rowData = {
                    nombre: p.name || '',
                    fecha: last.controlDate || '',
                    terreno: last.terreno?.progress || '0',
                    conexion: last.conexion?.progress || '0',
                    linea: last.linea?.progress || '0',
                    permiso: last.permiso?.progress || '0',
                    comunidades: last.comunidades?.progress || '0'
                };
                reportData.push(rowData);
            });

            html = `<h4>Control de todos los proyectos</h4>
                    <div id="report-control-chart"></div>`;
            resultado.innerHTML = html;
            setTimeout(() => generateControlChart(reportData), 200);
            currentReportDataForCSV = { type: 'control-general', data: reportData };

        } else if (tipoReporte.value === 'control-proyecto') {
            // Tabla de control de un proyecto
            const id = selectProyecto.value;
            const p = getControlProjects().find(x => (x.id||x.name) == id);
            const chartData = [];
            const chartLabels = [];
            
            html = `<h4>Control de proyecto: ${p?.name||''}</h4>
                    <div style="display: flex; gap: 24px;">
                        <div style="flex: 1;">
                            <div class="chart-container" style="height: 300px; margin-bottom: 24px;"><canvas id="project-progress-chart"></canvas></div>
                            <table class="control-table"><thead><tr><th>Fecha</th><th>Terreno (%)</th><th>Conexión (%)</th><th>Línea (%)</th><th>Permiso Amb. (%)</th><th>Comunidades (%)</th><th>Total (%)</th></tr></thead><tbody>`;
            (p?.controls||[]).forEach(c => {
                const terreno = parseFloat(c.terreno?.progress || 0);
                const conexion = parseFloat(c.conexion?.progress || 0);
                const linea = parseFloat(c.linea?.progress || 0);
                const permiso = parseFloat(c.permiso?.progress || 0);
                const comunidades = parseFloat(c.comunidades?.progress || 0);
                const totalAvance = ((terreno + conexion + linea + permiso + comunidades) / 5).toFixed(1);
                
                chartLabels.push(c.controlDate || '');
                chartData.push(parseFloat(totalAvance));
                
                html += `<tr><td>${c.controlDate||''}</td><td>${c.terreno?.progress||'0'}</td><td>${c.conexion?.progress||'0'}</td><td>${c.linea?.progress||'0'}</td><td>${c.permiso?.progress||'0'}</td><td>${c.comunidades?.progress||'0'}</td><td style="font-weight: 600; color: var(--primary);">${totalAvance}</td></tr>`;
            });
            html += '</tbody></table></div>';
            
            // Agregar panel de comentarios
            html += '<div style="flex: 0 0 300px; background: var(--light-card); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow-sm); border: 1px solid var(--border);">';
            html += '<h5 style="color: var(--primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;"><i class="fas fa-comments"></i> Comentarios del Proyecto</h5>';
            
            if (p?.controls && p.controls.length > 0) {
                const allComments = [];
                p.controls.forEach(control => {
                    ['terreno', 'conexion', 'linea', 'permiso', 'comunidades'].forEach(milestone => {
                        if (control[milestone] && control[milestone].commentsHistory) {
                            control[milestone].commentsHistory.forEach(comment => {
                                allComments.push({
                                    date: comment.date,
                                    text: comment.text,
                                    milestone: milestone,
                                    controlDate: comment.controlDate
                                });
                            });
                        }
                    });
                });
                
                // Ordenar comentarios por fecha de control (más recientes primero)
                allComments.sort((a, b) => new Date(b.controlDate) - new Date(a.controlDate));
                
                if (allComments.length > 0) {
                    html += '<div style="max-height: 400px; overflow-y: auto;">';
                    allComments.forEach(comment => {
                        const milestoneNames = {
                            'terreno': 'Terreno',
                            'conexion': 'Conexión',
                            'linea': 'Línea',
                            'permiso': 'Permiso Amb.',
                            'comunidades': 'Comunidades'
                        };
                        html += `<div style="background: #f8f9fa; padding: 12px; margin-bottom: 8px; border-radius: 6px; border-left: 3px solid var(--primary-light);">`;
                        html += `<div style="font-size: 12px; color: var(--text-secondary); font-weight: 600; margin-bottom: 4px;">${comment.date} - ${milestoneNames[comment.milestone]}</div>`;
                        html += `<div style="font-size: 14px; line-height: 1.4;">${comment.text}</div>`;
                        html += `</div>`;
                    });
                    html += '</div>';
                } else {
                    html += '<p style="color: var(--text-secondary); font-style: italic; text-align: center;">No hay comentarios registrados</p>';
                }
            } else {
                html += '<p style="color: var(--text-secondary); font-style: italic; text-align: center;">No hay comentarios registrados</p>';
            }
            
            html += '</div></div>';
            resultado.innerHTML = html;
            
            setTimeout(() => {
                const ctx = document.getElementById('project-progress-chart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: chartLabels,
                            datasets: [{
                                label: 'Avance Total (%)',
                                data: chartData,
                                borderColor: '#2c5aa0',
                                backgroundColor: 'rgba(44, 90, 160, 0.1)',
                                fill: true,
                                tension: 0.3,
                                pointBackgroundColor: '#2c5aa0',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 5
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Evolución del Avance Total del Proyecto'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    title: {
                                        display: true,
                                        text: 'Porcentaje (%)'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Fecha de Control'
                                    }
                                }
                            }
                        }
                    });
                }
            }, 200);
        } else if (tipoReporte.value === 'eval-proyecto') {
            // Tabla de evaluación de un proyecto
            const id = selectProyecto.value;
            const p = getEvalProjects().find(x => (x.id||x.name) == id);
            const results = p ? calculateProjectResults(p) : null;
            
            html = `<h4>Evaluación de proyecto: ${p?.name||''}</h4><table class="control-table report-table-compact"><thead><tr><th>Campo</th><th>Valor</th></tr></thead><tbody>`;
            if (p) {
                html += `<tr><td>Nombre</td><td>${p.name||''}</td></tr>`;
                html += `<tr><td>Ubicación</td><td>${p.location||''}</td></tr>`;
                html += `<tr><td>Tecnología</td><td>${p.tech||''}</td></tr>`;
                html += `<tr><td>Capex (mUSD)</td><td>${p.capex||''}</td></tr>`;
                html += `<tr><td>Opex (mUSD/año)</td><td>${p.opex||''}</td></tr>`;
                html += `<tr><td>Precio Energía (USD/MWh)</td><td>${p.price||''}</td></tr>`;
                html += `<tr><td>Plazo Evaluación (años)</td><td>${p.period||''}</td></tr>`;
                html += `<tr><td>Tasa Descuento (%)</td><td>${p.discount||''}</td></tr>`;
                html += `<tr><td>Producción Anual (MWh)</td><td>${p.production||''}</td></tr>`;
                if (results) {
                    html += `<tr><td style="font-weight: 700; border-top: 3px solid var(--primary);">VPN (mUSD)</td><td style="font-weight: 700; color: ${parseFloat(results.npv) >= 0 ? 'var(--primary)' : 'var(--accent)'}; border-top: 3px solid var(--primary);">${results.npv}</td></tr>`;
                    html += `<tr><td style="font-weight: 700;">TIR (%)</td><td style="font-weight: 700; color: var(--primary)">${results.irr}</td></tr>`;
                    html += `<tr><td style="font-weight: 700;">Payback (años)</td><td style="font-weight: 700; color: var(--primary)">${results.payback}</td></tr>`;
                }
            }
            html += '</tbody></table>';
            resultado.innerHTML = html;
        } else if (tipoReporte.value === 'eval-varios') {
            // Tabla transpuesta: características/resultados en filas, proyectos en columnas
            const ids = Array.from(selectVarios.selectedOptions).map(opt => opt.value);
            console.log('IDs seleccionados:', ids); // Debug
            
            const allProjects = getEvalProjects();
            console.log('Todos los proyectos:', allProjects); // Debug
            
            const ps = allProjects.filter(x => ids.includes(x.id?.toString() || x.name));
            console.log('Proyectos filtrados:', ps); // Debug
            
            if (ps.length === 0) {
                resultado.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i> No se encontraron proyectos seleccionados. Por favor selecciona al menos un proyecto.</div>';
                return;
            }
            
            // Calcular resultados para cada proyecto
            const projectsWithResults = ps.map(p => {
                const results = calculateProjectResults(p);
                return { ...p, results };
            });
            
            const reportData = [];
            const fields = [ // Definir campos para el reporte
                { label: 'Nombre', key: 'name' },
                { label: 'Ubicación', key: 'location' },
                { label: 'Tecnología', key: 'tech' },
                { label: 'Capex (mUSD)', key: 'capex' },
                { label: 'Opex (mUSD/año)', key: 'opex' },
                { label: 'Precio Energía (USD/MWh)', key: 'price' },
                { label: 'Plazo Evaluación (años)', key: 'period' },
                { label: 'Tasa Descuento (%)', key: 'discount' },
                { label: 'Producción Anual (MWh)', key: 'production' },
                { label: 'VPN (mUSD)', key: 'results.npv', isResult: true, isFirstResult: true },
                { label: 'TIR (%)', key: 'results.irr', isResult: true },
                { label: 'Payback (años)', key: 'results.payback', isResult: true }
            ];

            // Preparar datos para CSV
            const csvHeaders = ['Campo', ...projectsWithResults.map(p => p.name || 'Sin nombre')];
            reportData.push(csvHeaders);
            fields.forEach(f => {
                const row = [f.label, ...projectsWithResults.map(p => getNestedValue(p, f.key) || '-')];
                reportData.push(row);
            });

            html = `<h4>Evaluaciones de varios proyectos (${ps.length} seleccionados)</h4>
                    <div style="overflow-x: auto; margin-bottom: 20px;">
                        <table class="control-table report-table-compact">
                            <thead>
                                <tr>
                                    <th style="min-width: 200px;">Campo</th>
                                    ${projectsWithResults.map(p => `<th style="min-width: 150px;">${p.name || 'Sin nombre'}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${fields.map(f => {
                                    const rowClass = f.isResult ? 'result-row' : '';
                                    const borderStyle = f.isFirstResult ? 'border-top: 3px solid var(--primary);' : '';
                                    const cellStyle = f.isResult ? `font-weight: 700; ${borderStyle}` : `font-weight:600; background: rgba(26, 58, 95, 0.05); ${borderStyle}`;
                                    return `<tr class="${rowClass}"><td style='${cellStyle}'>${f.label}</td>${projectsWithResults.map(p => {
                                        const value = getNestedValue(p, f.key) || '-';
                                        const cellColor = f.isResult && f.key.includes('npv') && parseFloat(value) < 0 ? 'color: var(--accent);' : 
                                                         f.isResult && f.key.includes('npv') && parseFloat(value) >= 0 ? 'color: var(--primary);' : 
                                                         f.isResult ? 'color: var(--primary);' : '';
                                        return `<td style="${cellColor} ${borderStyle}">${value}</td>`;
                                    }).join('')}</tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>`;
            resultado.innerHTML = html;
            currentReportDataForCSV = { type: 'eval-varios', data: reportData };
        }
    });

    // --- INICIO: Funcionalidad de descarga CSV ---
    btnDescargar.addEventListener('click', function() {
        if (!currentReportDataForCSV) {
            showNotification('Primero genera un reporte para poder descargarlo.', 'warning');
            return;
        }

        let csvContent = "data:text/csv;charset=utf-8,";
        let dataToExport;

        if (currentReportDataForCSV.type === 'eval-varios') {
            dataToExport = currentReportDataForCSV.data;
            dataToExport.forEach(rowArray => {
                let row = rowArray.map(item => `"${String(item).replace(/"/g, '""')}"`).join(",");
                csvContent += row + "\r\n";
            });
        } else if (currentReportDataForCSV.type === 'control-general') {
            const headers = Object.keys(currentReportDataForCSV.data[0]);
            csvContent += headers.join(",") + "\r\n";
            currentReportDataForCSV.data.forEach(item => {
                let row = headers.map(header => `"${String(item[header]).replace(/"/g, '""')}"`).join(",");
                csvContent += row + "\r\n";
            });
        } else {
            showNotification('La descarga CSV solo está disponible para "Evaluaciones de varios proyectos" y "Control general".', 'info');
            return;
        }

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `reporte_${currentReportDataForCSV.type}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showNotification('Reporte descargado como CSV.', 'success');
    });
    // --- FIN: Funcionalidad de descarga CSV ---

    // --- INICIO: Gráfico tipo Gantt para Control General ---
    function generateControlChart(data) {
        const chartContainer = document.getElementById('report-control-chart').parentElement;
        const projects = getControlProjects();
        
        if (projects.length === 0) {
            chartContainer.innerHTML = '<p class="error-message"><i class="fas fa-exclamation-triangle"></i> No hay proyectos para mostrar</p>';
            return;
        }
        
        const validProjects = [];
        let allDates = [];
        
        projects.forEach(project => {
            if (project.controls && project.controls.length > 0) {
                const latestControl = project.controls.sort((a, b) => new Date(b.controlDate) - new Date(a.controlDate))[0];
                const startDate = latestControl.startDate ? new Date(latestControl.startDate) : null;
                
                if (startDate) {
                    let endDate = null;
                    let totalProgress = 0;
                    let milestoneCount = 0;
                    
                    ['terreno', 'conexion', 'linea', 'permiso', 'comunidades'].forEach(milestone => {
                        if (latestControl[milestone]) {
                            const milestoneEnd = latestControl[milestone].end ? new Date(latestControl[milestone].end) : null;
                            if (milestoneEnd && (!endDate || milestoneEnd > endDate)) {
                                endDate = milestoneEnd;
                            }
                            totalProgress += parseFloat(latestControl[milestone].progress || 0);
                            milestoneCount++;
                        }
                    });
                    
                    if (endDate && milestoneCount > 0) {
                        const avgProgress = totalProgress / milestoneCount;
                        allDates.push(startDate, endDate);
                        validProjects.push({
                            name: project.name,
                            start: startDate,
                            end: endDate,
                            progress: avgProgress
                        });
                    }
                }
            }
        });
        
        if (validProjects.length === 0) {
            chartContainer.innerHTML = '<p class="error-message"><i class="fas fa-exclamation-triangle"></i> No hay proyectos válidos con fechas completas para mostrar</p>';
            return;
        }
        
        // Calcular altura dinámica basada en número de proyectos
        const chartHeight = validProjects.length * 40 + 20; // 40px por proyecto + 20px de margen mínimo
        
        // Generar tabla HTML
        let tableHtml = '<table class="control-table" style="margin-top: 24px;"><thead><tr><th>Nombre</th><th>Última Fecha Control</th><th>Avance Terreno (%)</th><th>Avance Conexión (%)</th><th>Avance Línea (%)</th><th>Permiso Amb. (%)</th><th>Comunidades (%)</th></tr></thead><tbody>';
        data.forEach(rowData => {
            tableHtml += `<tr><td>${rowData.nombre}</td><td>${rowData.fecha}</td><td>${rowData.terreno}</td><td>${rowData.conexion}</td><td>${rowData.linea}</td><td>${rowData.permiso}</td><td>${rowData.comunidades}</td></tr>`;
        });
        tableHtml += '</tbody></table>';
        
        chartContainer.innerHTML = `<div class="gantt-container"><h4><i class="fas fa-chart-gantt"></i> Cronograma - Diagrama de Gantt</h4><div class="gantt-wrapper"><div class="gantt-labels" id="report-gantt-labels" style="height: ${chartHeight}px;"></div><div class="gantt-chart" id="report-gantt-chart" style="height: ${chartHeight}px;"></div></div><div id="report-gantt-dates" style="height: 30px; position: relative; margin-left: 180px; border-top: 1px solid #e9ecef; background: #f8f9fa;"></div></div>${tableHtml}`;
        
        const ganttChart = document.getElementById('report-gantt-chart');
        const ganttLabels = document.getElementById('report-gantt-labels');
        const ganttDates = document.getElementById('report-gantt-dates');
        
        const minDate = new Date(Math.min(...allDates));
        const maxDate = new Date(Math.max(...allDates));
        const startDateAdjusted = new Date(minDate);
        startDateAdjusted.setMonth(startDateAdjusted.getMonth() - 1);
        const endDateAdjusted = new Date(maxDate);
        endDateAdjusted.setMonth(endDateAdjusted.getMonth() + 1);
        const totalDays = Math.ceil((endDateAdjusted - startDateAdjusted) / (1000 * 60 * 60 * 24));
        const dayWidth = ganttChart.offsetWidth / totalDays;
        
        // Crear etiquetas de proyectos
        validProjects.forEach((project, index) => {
            const label = document.createElement('div');
            label.className = 'gantt-label';
            label.style.top = `${index * 40 + 10}px`;
            label.innerHTML = `<i class="fas fa-project-diagram"></i> ${project.name}`;
            ganttLabels.appendChild(label);
        });
        
        // Crear barras de proyectos
        validProjects.forEach((project, index) => {
            const daysFromStart = Math.ceil((project.start - startDateAdjusted) / (1000 * 60 * 60 * 24));
            const taskDuration = Math.ceil((project.end - project.start) / (1000 * 60 * 60 * 24));
            
            const taskElement = document.createElement('div');
            taskElement.className = 'gantt-item';
            taskElement.style.left = `${daysFromStart * dayWidth}px`;
            taskElement.style.width = `${taskDuration * dayWidth}px`;
            taskElement.style.top = `${index * 40 + 6}px`;
            taskElement.title = `${project.name}\nInicio: ${project.start.toLocaleDateString('es-ES')}\nFin: ${project.end.toLocaleDateString('es-ES')}\nDuración: ${taskDuration} días\nProgreso: ${Math.round(project.progress)}%`;
            
            const progressElement = document.createElement('div');
            progressElement.className = 'gantt-progress';
            progressElement.style.width = `${project.progress}%`;
            
            const progressLabel = document.createElement('span');
            progressLabel.className = 'gantt-progress-label';
            progressLabel.textContent = `${Math.round(project.progress)}%`;
            progressElement.appendChild(progressLabel);
            
            taskElement.appendChild(progressElement);
            ganttChart.appendChild(taskElement);
        });
        
        // Agregar escala de tiempo
        let step = totalDays < 60 ? 7 : totalDays < 120 ? 14 : 30;
        for (let i = 0; i <= totalDays; i += step) {
            const timeMarker = document.createElement('div');
            timeMarker.style.position = 'absolute';
            timeMarker.style.left = `${i * dayWidth}px`;
            timeMarker.style.top = '0';
            timeMarker.style.width = '1px';
            timeMarker.style.height = '100%';
            timeMarker.style.backgroundColor = '#e9ecef';
            timeMarker.style.zIndex = '1';
            ganttChart.appendChild(timeMarker);
            
            const dateLabel = document.createElement('div');
            dateLabel.style.position = 'absolute';
            dateLabel.style.left = `${i * dayWidth}px`;
            dateLabel.style.top = '5px';
            dateLabel.style.fontSize = '12px';
            dateLabel.style.color = '#6c757d';
            dateLabel.style.fontWeight = '500';
            dateLabel.style.transform = 'translateX(-50%)';
            dateLabel.style.whiteSpace = 'nowrap';
            dateLabel.style.textAlign = 'center';
            const currentDate = new Date(startDateAdjusted);
            currentDate.setDate(startDateAdjusted.getDate() + i);
            const monthNames = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
            const month = monthNames[currentDate.getMonth()];
            const year = currentDate.getFullYear().toString().slice(-2);
            dateLabel.textContent = `${month}-${year}`;
            ganttDates.appendChild(dateLabel);
        }
        
        // Línea de "Hoy"
        const today = new Date();
        if (today >= startDateAdjusted && today <= endDateAdjusted) {
            const daysFromStartToday = Math.ceil((today - startDateAdjusted) / (1000 * 60 * 60 * 24));
            const todayLine = document.createElement('div');
            todayLine.className = 'gantt-today-line';
            todayLine.style.left = `${daysFromStartToday * dayWidth}px`;
            todayLine.title = `Hoy: ${today.toLocaleDateString('es-ES')}`;
            ganttChart.appendChild(todayLine);
        }
    }
    // --- FIN: Gráfico para Control General ---
    
    // --- INICIO: Funciones para calcular resultados de evaluación ---
    function calculateProjectResults(project) {
        try {
            const capex = parseFloat(project.capex) || 0;
            const opex = parseFloat(project.opex) || 0;
            const price = parseFloat(project.price) || 0;
            const period = parseInt(project.period) || 0;
            const discount = parseFloat(project.discount) / 100 || 0;
            const production = parseFloat(project.production) || 0;
            
            if (capex === 0 || period === 0) {
                return { npv: 'N/A', irr: 'N/A', payback: 'N/A' };
            }
            
            let cashflows = [-capex];
            let npv = -capex;
            
            for (let i = 1; i <= period; i++) {
                const revenue = production * price / 1000;
                const cf = revenue - opex;
                cashflows.push(cf);
                npv += cf / Math.pow(1 + discount, i);
            }
            
            const irr = calculateProjectIRR(cashflows);
            const payback = calculateProjectPayback(cashflows);
            
            return {
                npv: npv.toFixed(2),
                irr: irr.toFixed(2),
                payback: payback
            };
        } catch (e) {
            console.error('Error calculating project results:', e);
            return { npv: 'Error', irr: 'Error', payback: 'Error' };
        }
    }
    
    function calculateProjectIRR(cashflows) {
        try {
            let irr = 0.1;
            const maxIterations = 1000;
            const precision = 0.00001;
            
            for (let i = 0; i < maxIterations; i++) {
                const npv = cashflows.reduce((sum, cf, t) => sum + cf / Math.pow(1 + irr, t), 0);
                if (Math.abs(npv) < precision) break;
                const derivative = cashflows.reduce((sum, cf, t) => t > 0 ? sum - t * cf / Math.pow(1 + irr, t + 1) : sum, 0);
                if (derivative === 0) break;
                irr -= npv / derivative;
            }
            return irr * 100;
        } catch (e) {
            return 0;
        }
    }
    
    function calculateProjectPayback(cashflows) {
        try {
            let cumulative = 0;
            for (let i = 0; i < cashflows.length; i++) {
                cumulative += cashflows[i];
                if (cumulative >= 0) {
                    if (i === 0) return '0.0';
                    const fraction = (cumulative - cashflows[i]) / cashflows[i];
                    return (i - 1 + fraction).toFixed(1);
                }
            }
            return 'N/A';
        } catch (e) {
            return 'N/A';
        }
    }
    
    function getNestedValue(obj, path) {
        return path.split('.').reduce((current, key) => current && current[key], obj);
    }
    // --- FIN: Funciones para calcular resultados de evaluación ---

    // Inicializar selectores
    tipoReporte.dispatchEvent(new Event('change'));
});
        // Fallback for localStorage
        let mockStorage = {};
        const safeStorage = {
            getItem: key => {
                try {
                    return localStorage.getItem(key) || mockStorage[key] || null;
                } catch (e) {
                    console.error('Storage get error:', e);
                    return mockStorage[key] || null;
                }
            },
            setItem: (key, value) => {
                try {
                    localStorage.setItem(key, value);
                    mockStorage[key] = value;
                } catch (e) {
                    console.error('Storage set error:', e);
                    mockStorage[key] = value;
                }
            }
        };
        let currentEvalProject = null;
        let currentControlProject = null;
        let cashflowChart = null;

        // --- INICIO: Sistema de Notificaciones Moderno ---
        function showNotification(message, type = 'info') {
            const container = document.body;
            const notification = document.createElement('div');
            const iconClass = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-triangle',
                'warning': 'fa-exclamation-circle',
                'info': 'fa-info-circle'
            }[type];

            notification.className = `success-message`; // Usamos una clase base para el estilo
            if (type === 'error' || type === 'warning') {
                notification.className = `error-message`;
            }
            notification.style.position = 'fixed';
            notification.style.top = '90px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.innerHTML = `<i class="fas ${iconClass}"></i> ${message}`;
            container.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }
        // --- FIN: Sistema de Notificaciones Moderno ---

        function showPage(pageId) {
            try {
                document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                const page = document.getElementById(pageId);
                if (!page) throw new Error(`Page ${pageId} not found`);
                page.classList.add('active');
                window.scrollTo(0, 0);
                // Highlight active nav link
                document.querySelectorAll('nav a').forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('onclick').includes(pageId)) {
                        link.classList.add('active');
                    }
                });
                if (pageId === 'evaluacion') {
                    loadEvalProjects();
                    document.getElementById('eval-form')?.reset();
                    document.getElementById('eval-results').innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--text-secondary); font-style: italic;">Completa el formulario y haz clic en "Evaluar" para ver los resultados</td></tr>';
                    if (cashflowChart) {
                        cashflowChart.destroy();
                        cashflowChart = null;
                    }
                } else if (pageId === 'control') {
                    loadControlProjects();
                    document.getElementById('control-project-name-header').value = '';
                    document.getElementById('proyecto-start').value = '';
                    document.querySelectorAll('.progress-item input[type="number"]').forEach(input => input.value = '0');
                    document.querySelectorAll('.progress-item input[type="date"]').forEach(input => input.value = '');
                    document.querySelectorAll('.control-table textarea').forEach(textarea => textarea.value = '');
                    document.querySelectorAll('.progress-fill').forEach(bar => bar.style.width = '0%');
                    updateGanttChart();
                } else if (pageId === 'reporte') {
                    // Habilitar todos los campos al entrar a la pestaña reporte
                    document.querySelectorAll('input, select, textarea').forEach(field => {
                        field.disabled = false;
                    });
                }
            } catch (e) {
                console.error('Error in showPage:', e);
                showNotification('Error al cambiar de página.', 'error');
            }
        }
        // Evaluación Functions
        async function loadEvalProjects() {
            try {
                let projects = [];
                
                // Intentar cargar desde Supabase primero
                try {
                    const { data, error } = await supabase
                        .from('eval_projects')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (!error) {
                        projects = data || [];
                    }
                } catch (supabaseError) {
                    console.log('Supabase no disponible, usando localStorage');
                }
                
                // Si Supabase falla, usar localStorage
                if (projects.length === 0) {
                    projects = JSON.parse(safeStorage.getItem('evalProjects') || '[]');
                }

                const list = document.getElementById('eval-project-list');
                if (!list) throw new Error('Eval project list not found');
                list.innerHTML = '';
                
                // Agregar botón + Proyecto al inicio
                const newProjectLi = document.createElement('li');
                newProjectLi.innerHTML = `<i class="fas fa-plus"></i> Evaluación`;
                newProjectLi.style.fontWeight = 'bold';
                newProjectLi.style.fontSize = '14px';
                newProjectLi.onclick = () => addNewEvalProject();
                list.appendChild(newProjectLi);

                // Agregar proyecto fijo "Ejemplo" en segunda posición
                const ejemploLi = document.createElement('li');
                ejemploLi.innerHTML = `<i class="fas fa-file-alt"></i> Ejemplo`;
                ejemploLi.onclick = () => selectEvalProject({
                    name: 'Ejemplo',
                    location: 'Buenos Aires',
                    tech: 'Solar',
                    capex: 2.5,
                    opex: 0.15,
                    price: 60,
                    period: 20,
                    discount: 8,
                    production: 5000
                });
                list.appendChild(ejemploLi);

                projects.forEach(project => {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="fas fa-file-alt"></i> ${project.name || 'Proyecto sin nombre'}`;
                    li.onclick = () => selectEvalProject(project);
                    if (project.id === currentEvalProject) li.classList.add('active');
                    list.appendChild(li);
                });
            } catch (e) {
                console.error('Error loading eval projects:', e);
                document.getElementById('eval-project-list').innerHTML = '<li class="error-message"><i class="fas fa-exclamation-triangle"></i> Error al cargar proyectos</li>';
            }
        }
        function selectEvalProject(project) {
            try {
                if (!project) throw new Error('Invalid project selected');
                currentEvalProject = project.id;
                document.querySelectorAll('#eval-project-list li').forEach(li => li.classList.remove('active'));
                const selectedLi = Array.from(document.querySelectorAll('#eval-project-list li')).find(li => li.textContent.includes(project.name));
                if (selectedLi) selectedLi.classList.add('active');
                document.getElementById('eval-name').value = project.name || '';
                document.getElementById('eval-location').value = project.location || '';
                document.getElementById('eval-tech').value = project.tech || '';
                document.getElementById('eval-capex').value = project.capex || '';
                document.getElementById('eval-opex').value = project.opex || '';
                document.getElementById('eval-price').value = project.price || '';
                document.getElementById('eval-period').value = project.period || '';
                document.getElementById('eval-discount').value = project.discount || '';
                document.getElementById('eval-production').value = project.production || '';
                document.getElementById('eval-results').innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--text-secondary); font-style: italic;">Proyecto cargado. Haz clic en "Evaluar" para ver los resultados actualizados</td></tr>';
                if (cashflowChart) {
                    cashflowChart.destroy();
                    cashflowChart = null;
                }
            } catch (e) {
                console.error('Error selecting eval project:', e);
                showNotification('Error al seleccionar el proyecto.', 'error');
            }
        }
        function validateEvalForm() {
            try {
                const inputs = [
                    { id: 'eval-name', label: 'Nombre' },
                    { id: 'eval-location', label: 'Ubicación' },
                    { id: 'eval-tech', label: 'Tecnología' },
                    { id: 'eval-capex', label: 'Capex', numeric: true },
                    { id: 'eval-opex', label: 'Opex', numeric: true },
                    { id: 'eval-price', label: 'Precio Energía', numeric: true },
                    { id: 'eval-period', label: 'Plazo de Evaluación', numeric: true, min: 1 },
                    { id: 'eval-discount', label: 'Tasa de Descuento', numeric: true },
                    { id: 'eval-production', label: 'Producción Anual', numeric: true }
                ];
                const errors = [];
                for (const input of inputs) {
                    const element = document.getElementById(input.id);
                    if (!element) throw new Error(`Input ${input.id} not found`);
                    const value = element.value;
                    if (!value) {
                        errors.push(`<i class="fas fa-exclamation-circle"></i> ${input.label} es requerido`);
                    } else if (input.numeric && (isNaN(value) || parseFloat(value) < (input.min || 0))) {
                        errors.push(`<i class="fas fa-exclamation-circle"></i> ${input.label} debe ser un número válido ${input.min ? `≥ ${input.min}` : '≥ 0'}`);
                    }
                }
                if (errors.length > 0) {
                    document.getElementById('eval-results').innerHTML = `<div class="error-message">${errors.join('<br>')}</div>`;
                    return false;
                }
                return true;
            } catch (e) {
                console.error('Error validating eval form:', e);
                document.getElementById('eval-results').innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Error al validar el formulario</div>';
                return false;
            }
        }
        function calculateEval() {
            if (!validateEvalForm()) return;
            try {
                const capex = parseFloat(document.getElementById('eval-capex').value);
                const opex = parseFloat(document.getElementById('eval-opex').value);
                const price = parseFloat(document.getElementById('eval-price').value);
                const period = parseInt(document.getElementById('eval-period').value);
                const discount = parseFloat(document.getElementById('eval-discount').value) / 100;
                const production = parseFloat(document.getElementById('eval-production').value);
                let cashflows = [-capex];
                let npv = -capex;
                for (let i = 1; i <= period; i++) {
                    const revenue = production * price / 1000;
                    const cf = revenue - opex;
                    cashflows.push(cf);
                    npv += cf / Math.pow(1 + discount, i);
                }
                const results = document.getElementById('eval-results');
                if (!results) throw new Error('Results element not found');
                const irr = calculateIRR(cashflows);
                const payback = calculatePayback(cashflows);
                results.innerHTML = `
                    <tr>
                        <td><i class="fas fa-dollar-sign"></i> Valor Presente Neto (VPN)</td>
                        <td class="value ${npv >= 0 ? 'positive' : 'negative'}">${npv.toFixed(2)} mUSD</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-percentage"></i> Tasa Interna de Retorno (TIR)</td>
                        <td class="value ${irr >= (discount * 100) ? 'positive' : 'negative'}">${irr.toFixed(2)} %</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-clock"></i> Período de Recuperación</td>
                        <td class="value">${payback} años</td>
                    </tr>
                `;
                if (!window.Chart) throw new Error('Chart.js not loaded');
                const canvas = document.getElementById('cashflow-chart');
                if (!canvas || !canvas.getContext('2d')) throw new Error('Canvas not supported');
                if (cashflowChart) {
                    cashflowChart.destroy();
                    cashflowChart = null;
                }
                cashflowChart = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: period + 1}, (_, i) => i),
                        datasets: [{
                            label: 'Flujo de Caja (mUSD)',
                            data: cashflows,
                            borderColor: '#2c5aa0',
                            backgroundColor: 'rgba(44, 90, 160, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointBackgroundColor: '#2c5aa0',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#212529',
                                    font: {
                                        size: 14,
                                        weight: '500'
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(44, 90, 160, 0.9)',
                                titleColor: '#ffffff',
                                bodyColor: '#ffffff',
                                borderColor: '#ffffff',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'mUSD',
                                    color: '#212529',
                                    font: {
                                        size: 14,
                                        weight: '500'
                                    }
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                },
                                ticks: {
                                    color: '#6c757d'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Año',
                                    color: '#212529',
                                    font: {
                                        size: 14,
                                        weight: '500'
                                    }
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                },
                                ticks: {
                                    color: '#6c757d'
                                }
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('Error calculating evaluation:', e);
                document.getElementById('eval-results').innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Error al calcular evaluación</div>';
            }
        }
        function calculateIRR(cashflows) {
            try {
                let irr = 0.1;
                let npv = 0;
                const maxIterations = 1000;
                const precision = 0.00001;
                for (let i = 0; i < maxIterations; i++) {
                    npv = cashflows.reduce((sum, cf, t) => sum + cf / Math.pow(1 + irr, t), 0);
                    if (Math.abs(npv) < precision) break;
                    const derivative = cashflows.reduce((sum, cf, t) => t > 0 ? sum - t * cf / Math.pow(1 + irr, t + 1) : sum, 0);
                    irr -= npv / derivative;
                }
                return irr * 100;
            } catch (e) {
                console.error('Error calculating IRR:', e);
                return 0;
            }
        }
        function calculatePayback(cashflows) {
            try {
                let cumulative = 0;
                for (let i = 0; i < cashflows.length; i++) {
                    cumulative += cashflows[i];
                    if (cumulative >= 0) {
                        if (i === 0) return 0;
                        const fraction = (cumulative - cashflows[i]) / cashflows[i];
                        return (i - 1 + fraction).toFixed(1);
                    }
                }
                return "N/A";
            } catch (e) {
                console.error('Error calculating payback:', e);
                return "N/A";
            }
        }
        async function saveEvalProject() {
            if (!validateEvalForm()) return;
            try {
                const projectData = {
                    id: currentEvalProject || Date.now(),
                    name: document.getElementById('eval-name').value,
                    location: document.getElementById('eval-location').value,
                    tech: document.getElementById('eval-tech').value,
                    capex: parseFloat(document.getElementById('eval-capex').value),
                    opex: parseFloat(document.getElementById('eval-opex').value),
                    price: parseFloat(document.getElementById('eval-price').value),
                    period: parseInt(document.getElementById('eval-period').value),
                    discount: parseFloat(document.getElementById('eval-discount').value),
                    production: parseFloat(document.getElementById('eval-production').value)
                };

                // Intentar guardar en Supabase
                try {
                    const { data, error } = await supabase
                        .from('eval_projects')
                        .insert([projectData]);
                    
                    if (!error) {
                        showNotification('Proyecto guardado en Supabase.', 'success');
                    }
                } catch (supabaseError) {
                    console.log('Supabase no disponible, guardando en localStorage');
                }
                
                // Siempre guardar en localStorage como respaldo
                const projects = JSON.parse(safeStorage.getItem('evalProjects') || '[]');
                const index = projects.findIndex(p => p.id === currentEvalProject);
                if (index > -1) {
                    projects[index] = projectData;
                } else {
                    projects.push(projectData);
                }
                safeStorage.setItem('evalProjects', JSON.stringify(projects));
                
                showNotification('Proyecto guardado exitosamente.', 'success');
                loadEvalProjects();
                document.getElementById('eval-form').reset();
                if (cashflowChart) {
                    cashflowChart.destroy();
                    cashflowChart = null;
                }
                currentEvalProject = null;
            } catch (e) {
                console.error('Error saving eval project:', e);
                showNotification('Error al guardar el proyecto.', 'error');
            }
        }
        function editEvalProject() {
            try {
                if (!currentEvalProject) throw new Error('No project selected');
                saveEvalProject();
            } catch (e) {
                console.error('Error editing eval project:', e);
                showNotification('Selecciona un proyecto para editar.', 'warning');
            }
        }
        function deleteEvalProject() {
            try {
                if (!currentEvalProject) throw new Error('No project selected');
                if (!confirm('¿Estás seguro de que deseas eliminar esta evaluación?')) return;
                let projects = JSON.parse(safeStorage.getItem('evalProjects') || '[]');
                projects = projects.filter(p => p.id !== currentEvalProject);
                safeStorage.setItem('evalProjects', JSON.stringify(projects));
                showNotification('Evaluación eliminada exitosamente.', 'success');
                document.getElementById('eval-form').reset();
                document.getElementById('eval-results').innerHTML = '<div class="success-message"><i class="fas fa-check-circle"></i> Proyecto eliminado exitosamente</div>';
                if (cashflowChart) {
                    cashflowChart.destroy();
                    cashflowChart = null;
                }
                currentEvalProject = null;
                setTimeout(() => {
                    document.getElementById('eval-results').innerHTML = '<p>Completa el formulario y haz clic en "Evaluar" para ver los resultados.</p>';
                }, 3000);
            } catch (e) {
                console.error('Error deleting eval project:', e);
                showNotification('Error al eliminar el proyecto.', 'error');
            }
        }
        // Control Functions
        function loadControlProjects() {
            try {
                const projects = JSON.parse(safeStorage.getItem('controlProjects') || '[]');
                const list = document.getElementById('control-project-list');
                if (!list) throw new Error('Control project list not found');
                list.innerHTML = '';
                
                // Agregar botón + Proyecto al inicio
                const newProjectLi = document.createElement('li');
                newProjectLi.innerHTML = `<i class="fas fa-plus"></i> Proyecto`;
                newProjectLi.style.fontWeight = 'bold';
                newProjectLi.style.fontSize = '14px';
                newProjectLi.onclick = () => addNewControlProject();
                list.appendChild(newProjectLi);

                // Agregar proyecto fijo "Ejemplo" en segunda posición
                const ejemploLi = document.createElement('li');
                ejemploLi.innerHTML = `<i class="fas fa-project-diagram"></i> Ejemplo`;
                ejemploLi.style.fontWeight = 'bold';
                ejemploLi.onclick = () => {
                    // Simular datos inventados para el proyecto Ejemplo
                    const ejemploProject = {
                        name: 'Ejemplo',
                        controls: [
                            {
                                controlDate: '2025-09-01',
                                startDate: '2025-01-01',
                                terreno: { progress: 100, start: '2025-01-10', end: '2025-02-10' },
                                conexion: { progress: 80, start: '2025-02-15', end: '2025-03-15' },
                                linea: { progress: 60, start: '2025-03-20', end: '2025-04-20' },
                                comentarios: 'Proyecto de ejemplo con datos ficticios.'
                            }
                        ]
                    };
                    loadLatestControlData(ejemploProject);
                };
                list.appendChild(ejemploLi);

                projects.forEach(project => {
                    const projectLi = document.createElement('li');
                    projectLi.innerHTML = `<i class="fas fa-project-diagram"></i> ${project.name || 'Proyecto sin nombre'}`;
                    projectLi.style.fontWeight = 'bold';
                    projectLi.onclick = () => loadLatestControlData(project);
                    list.appendChild(projectLi);
                    // Agregar "+Control"
                    const newControlLi = document.createElement('li');
                    newControlLi.innerHTML = `<i class="fas fa-plus"></i> Control`;
                    newControlLi.style.marginLeft = '20px';
                    newControlLi.style.fontSize = '13px';
                    newControlLi.onclick = () => createNewControl(project);
                    list.appendChild(newControlLi);
                    if (project.controls && project.controls.length > 0) {
                        // Ordenar controles por fecha de más nueva a más antigua
                        const sortedControls = project.controls.sort((a, b) => new Date(b.controlDate) - new Date(a.controlDate));
                        sortedControls.forEach(control => {
                            const controlLi = document.createElement('li');
                            controlLi.innerHTML = `${control.controlDate}`;
                            controlLi.style.marginLeft = '20px';
                            controlLi.style.fontSize = '13px';
                            controlLi.onclick = () => selectControlData(project, control);
                            list.appendChild(controlLi);
                        });
                    }
                });
            } catch (e) {
                console.error('Error loading control projects:', e);
                document.getElementById('control-project-list').innerHTML = '<li class="error-message"><i class="fas fa-exclamation-triangle"></i> Error al cargar proyectos</li>';
            }
        }
        function loadLatestControlData(project) {
            try {
                if (!project.controls || project.controls.length === 0) {
                    document.getElementById('control-project-name-header').value = project.name || '';
                    document.getElementById('control-date').value = '';
                    document.getElementById('proyecto-start').value = '';
                    return;
                }
                
                // Ordenar por fecha de control y tomar la más reciente
                const sortedControls = project.controls.sort((a, b) => new Date(b.controlDate) - new Date(a.controlDate));
                const latestControl = sortedControls[0];
                
                selectControlData(project, latestControl);
            } catch (e) {
                console.error('Error loading latest control data:', e);
                showNotification('Error al cargar la última información.', 'error');
            }
        }
        function createNewControl(project) {
            try {
                document.getElementById('control-project-name-header').value = project.name || '';
                document.getElementById('control-date').value = '';
                
                if (project.controls && project.controls.length > 0) {
                    // Ordenar y obtener la última actualización
                    const sortedControls = project.controls.sort((a, b) => new Date(b.controlDate) - new Date(a.controlDate));
                    const latestControl = sortedControls[0];
                    
                    // Prellenar campos con la última información
                    document.getElementById('proyecto-start').value = latestControl.startDate || '';
                    document.getElementById('terreno-progress').value = latestControl.terreno?.progress || '0';
                    document.getElementById('terreno-start').value = latestControl.terreno?.start || '';
                    document.getElementById('terreno-end').value = latestControl.terreno?.end || '';
                    document.getElementById('conexion-progress').value = latestControl.conexion?.progress || '0';
                    document.getElementById('conexion-start').value = latestControl.conexion?.start || '';
                    document.getElementById('conexion-end').value = latestControl.conexion?.end || '';
                    document.getElementById('linea-progress').value = latestControl.linea?.progress || '0';
                    document.getElementById('linea-start').value = latestControl.linea?.start || '';
                    document.getElementById('linea-end').value = latestControl.linea?.end || '';
                    document.getElementById('permiso-progress').value = latestControl.permiso?.progress || '0';
                    document.getElementById('permiso-start').value = latestControl.permiso?.start || '';
                    document.getElementById('permiso-end').value = latestControl.permiso?.end || '';
                    document.getElementById('comunidades-progress').value = latestControl.comunidades?.progress || '0';
                    document.getElementById('comunidades-start').value = latestControl.comunidades?.start || '';
                    document.getElementById('comunidades-end').value = latestControl.comunidades?.end || '';
                    
                    // Limpiar campos de comentarios nuevos pero mantener historial
                    document.getElementById('terreno-comments').value = '';
                    document.getElementById('conexion-comments').value = '';
                    document.getElementById('linea-comments').value = '';
                    document.getElementById('permiso-comments').value = '';
                    document.getElementById('comunidades-comments').value = '';
                    
                    // Mostrar comentarios de la última actualización y anteriores
                    ['terreno', 'conexion', 'linea', 'permiso', 'comunidades'].forEach(milestone => {
                        const historyDiv = document.getElementById(`${milestone}-comments-history`);
                        if (historyDiv) {
                            historyDiv.innerHTML = '';
                            if (latestControl[milestone] && latestControl[milestone].commentsHistory) {
                                const latestControlDate = new Date(latestControl.controlDate);
                                latestControl[milestone].commentsHistory.forEach(comment => {
                                    const commentControlDate = new Date(comment.controlDate);
                                    if (commentControlDate <= latestControlDate) {
                                        const commentDiv = document.createElement('div');
                                        commentDiv.className = 'comment-item';
                                        commentDiv.setAttribute('data-control-date', comment.controlDate);
                                        commentDiv.innerHTML = `
                                            <div class="comment-date">${comment.date}</div>
                                            <div class="comment-text">${comment.text}</div>
                                        `;
                                        historyDiv.appendChild(commentDiv);
                                    }
                                });
                            }
                        }
                    });
                } else {
                    clearAllFields();
                    document.getElementById('control-project-name-header').value = project.name || '';
                    // Limpiar historial de comentarios para proyecto nuevo
                    document.querySelectorAll('.comments-history').forEach(history => history.innerHTML = '');
                }
                
                enableFields();
                isEditMode = false;
                updateGanttChart();
            } catch (e) {
                console.error('Error creating new control:', e);
                showNotification('Error al crear nuevo control.', 'error');
            }
        }
        
        function selectControlData(project, control) {
            try {
                document.getElementById('control-project-name-header').value = project.name || '';
                document.getElementById('control-date').value = control.controlDate || '';
                document.getElementById('proyecto-start').value = control.startDate || '';
                document.getElementById('terreno-progress').value = control.terreno?.progress || '0';
                document.getElementById('terreno-start').value = control.terreno?.start || '';
                document.getElementById('terreno-end').value = control.terreno?.end || '';
                document.getElementById('terreno-comments').value = control.terreno?.comments || '';
                document.getElementById('conexion-progress').value = control.conexion?.progress || '0';
                document.getElementById('conexion-start').value = control.conexion?.start || '';
                document.getElementById('conexion-end').value = control.conexion?.end || '';
                document.getElementById('conexion-comments').value = control.conexion?.comments || '';
                document.getElementById('linea-progress').value = control.linea?.progress || '0';
                document.getElementById('linea-start').value = control.linea?.start || '';
                document.getElementById('linea-end').value = control.linea?.end || '';
                document.getElementById('linea-comments').value = control.linea?.comments || '';
                document.getElementById('permiso-progress').value = control.permiso?.progress || '0';
                document.getElementById('permiso-start').value = control.permiso?.start || '';
                document.getElementById('permiso-end').value = control.permiso?.end || '';
                document.getElementById('permiso-comments').value = control.permiso?.comments || '';
                document.getElementById('comunidades-progress').value = control.comunidades?.progress || '0';
                document.getElementById('comunidades-start').value = control.comunidades?.start || '';
                document.getElementById('comunidades-end').value = control.comunidades?.end || '';
                document.getElementById('comunidades-comments').value = control.comunidades?.comments || '';
                
                // Cargar comentarios de esta fecha y anteriores (no futuras)
                ['terreno', 'conexion', 'linea', 'permiso', 'comunidades'].forEach(milestone => {
                    const historyDiv = document.getElementById(`${milestone}-comments-history`);
                    if (historyDiv) {
                        historyDiv.innerHTML = '';
                        if (control[milestone] && control[milestone].commentsHistory) {
                            const currentControlDate = new Date(control.controlDate);
                            control[milestone].commentsHistory.forEach(comment => {
                                const commentControlDate = new Date(comment.controlDate);
                                if (commentControlDate <= currentControlDate) {
                                    const commentDiv = document.createElement('div');
                                    commentDiv.className = 'comment-item';
                                    commentDiv.setAttribute('data-control-date', comment.controlDate);
                                    commentDiv.innerHTML = `
                                        <div class="comment-date">${comment.date}</div>
                                        <div class="comment-text">${comment.text}</div>
                                    `;
                                    historyDiv.appendChild(commentDiv);
                                }
                            });
                        }
                    }
                });
                
                disableFields();
                isEditMode = false;
                updateGanttChart();
            } catch (e) {
                console.error('Error selecting control data:', e);
                showNotification('Error al seleccionar los datos de control.', 'error');
            }
        }
        function selectControlProject(project) {
            try {
                if (!project) throw new Error('Invalid project selected');
                currentControlProject = project.id;
                document.querySelectorAll('#control-project-list li').forEach(li => li.classList.remove('active'));
                const selectedLi = Array.from(document.querySelectorAll('#control-project-list li')).find(li => li.textContent.includes(project.name));
                if (selectedLi) selectedLi.classList.add('active');
                document.getElementById('control-project-name-header').value = project.name || '';
                document.getElementById('proyecto-start').value = project.startDate || '';
                document.getElementById('terreno-progress').value = project.terreno?.progress || '0';
                document.getElementById('terreno-start').value = project.terreno?.start || '';
                document.getElementById('terreno-end').value = project.terreno?.end || '';
                
                // Cargar historial de comentarios
                const terrenoHistory = document.getElementById('terreno-comments-history');
                terrenoHistory.innerHTML = '';
                if (project.terreno?.commentsHistory) {
                    project.terreno.commentsHistory.forEach(comment => {
                        const commentDiv = document.createElement('div');
                        commentDiv.className = 'comment-item';
                        commentDiv.innerHTML = `
                            <div class="comment-date">${comment.date}</div>
                            <div class="comment-text">${comment.text}</div>
                        `;
                        terrenoHistory.appendChild(commentDiv);
                    });
                }
                document.getElementById('terreno-comments').value = '';
                document.getElementById('conexion-progress').value = project.conexion?.progress || '0';
                document.getElementById('conexion-start').value = project.conexion?.start || '';
                document.getElementById('conexion-end').value = project.conexion?.end || '';
                document.getElementById('conexion-comments').value = project.conexion?.comments || '';
                document.getElementById('linea-progress').value = project.linea?.progress || '0';
                document.getElementById('linea-start').value = project.linea?.start || '';
                document.getElementById('linea-end').value = project.linea?.end || '';
                document.getElementById('linea-comments').value = project.linea?.comments || '';
                document.getElementById('permiso-progress').value = project.permiso?.progress || '0';
                document.getElementById('permiso-start').value = project.permiso?.start || '';
                document.getElementById('permiso-end').value = project.permiso?.end || '';
                document.getElementById('permiso-comments').value = project.permiso?.comments || '';
                document.getElementById('comunidades-progress').value = project.comunidades?.progress || '0';
                document.getElementById('comunidades-start').value = project.comunidades?.start || '';
                document.getElementById('comunidades-end').value = project.comunidades?.end || '';
                document.getElementById('comunidades-comments').value = project.comunidades?.comments || '';
                document.querySelectorAll('.progress-fill').forEach(bar => {
                    const id = bar.id.replace('-progress-bar', '');
                    const value = document.getElementById(`${id}-progress`).value;
                    bar.style.width = `${value || 0}%`;
                });

                updateGanttChart();
            } catch (e) {
                console.error('Error selecting control project:', e);
                showNotification('Error al seleccionar el proyecto.', 'error');
            }
        }
        function validateControlForm() {
            try {
                const name = document.getElementById('control-project-name-header').value;
                const controlDate = document.getElementById('control-date').value;
                if (!name) {
                    showNotification('El nombre del proyecto es requerido.', 'warning');
                    return false;
                }
                if (!controlDate) {
                    showNotification('La fecha de control es requerida.', 'warning');
                    return false;
                }
                const milestones = ['terreno', 'conexion', 'linea', 'permiso', 'comunidades'];
                for (const m of milestones) {
                    const progress = document.getElementById(`${m}-progress`).value;
                    const start = document.getElementById(`${m}-start`).value;
                    const end = document.getElementById(`${m}-end`).value;
                    if (progress && (isNaN(progress) || progress < 0 || progress > 100)) {
                        showNotification(`El porcentaje de avance de ${m} debe estar entre 0 y 100.`, 'warning');
                        return false;
                    }
                    if ((start || end) && (!start || !end)) {
                        showNotification(`Debes ingresar ambas fechas (inicio y fin) para ${m}.`, 'warning');
                        return false;
                    }
                    if (start && end && new Date(start) > new Date(end)) {
                        alert(`La fecha de término de ${m} debe ser posterior a la de inicio`);
                        return false;
                    }
                }
                return true;
            } catch (e) {
                console.error('Error validating control form:', e);
                showNotification('Error al validar el formulario.', 'error');
                return false;
            }
        }
        function updateProgress(area, value) {
            try {
                if (isNaN(value) || value < 0 || value > 100) return;
                const progressBar = document.getElementById(`${area}-progress-bar`);
                if (progressBar) progressBar.style.width = `${value}%`;
                updateGanttChart();
            } catch (e) {
                console.error('Error updating progress:', e);
            }
        }
        function updateGanttChart() {
            try {
                const ganttChart = document.getElementById('gantt-chart');
                const ganttLabels = document.getElementById('gantt-labels');
                const ganttDates = document.getElementById('gantt-dates');
                if (!ganttChart || !ganttLabels) throw new Error('Gantt chart or labels container not found');
                ganttChart.innerHTML = '';
                ganttLabels.innerHTML = '';
                if (ganttDates) ganttDates.innerHTML = '';
                const startDate = document.getElementById('proyecto-start') ? document.getElementById('proyecto-start').valueAsDate : null;
                if (!startDate) {
                    ganttChart.innerHTML = '<p class="error-message"><i class="fas fa-exclamation-triangle"></i> Por favor, selecciona una fecha de inicio del proyecto</p>';
                    return;
                }
                const tasks = [
                    { 
                        name: 'Terreno', 
                        start: document.getElementById('terreno-start').valueAsDate || new Date(startDate),
                        end: document.getElementById('terreno-end').valueAsDate || new Date(startDate.getTime() + 30 * 24 * 60 * 60 * 1000),
                        progress: parseFloat(document.getElementById('terreno-progress').value) || 0
                    },
                    { 
                        name: 'Conexión', 
                        start: document.getElementById('conexion-start').valueAsDate || new Date(startDate.getTime() + 30 * 24 * 60 * 60 * 1000),
                        end: document.getElementById('conexion-end').valueAsDate || new Date(startDate.getTime() + 60 * 24 * 60 * 60 * 1000),
                        progress: parseFloat(document.getElementById('conexion-progress').value) || 0
                    },
                    { 
                        name: 'Línea', 
                        start: document.getElementById('linea-start').valueAsDate || new Date(startDate.getTime() + 60 * 24 * 60 * 60 * 1000),
                        end: document.getElementById('linea-end').valueAsDate || new Date(startDate.getTime() + 90 * 24 * 60 * 60 * 1000),
                        progress: parseFloat(document.getElementById('linea-progress').value) || 0
                    },
                    { 
                        name: 'Permiso Ambiental', 
                        start: document.getElementById('permiso-start').valueAsDate || new Date(startDate),
                        end: document.getElementById('permiso-end').valueAsDate || new Date(startDate.getTime() + 30 * 24 * 60 * 60 * 1000),
                        progress: parseFloat(document.getElementById('permiso-progress').value) || 0
                    },
                    { 
                        name: 'Comunidades', 
                        start: document.getElementById('comunidades-start').valueAsDate || new Date(startDate.getTime() + 30 * 24 * 60 * 60 * 1000),
                        end: document.getElementById('comunidades-end').valueAsDate || new Date(startDate.getTime() + 60 * 24 * 60 * 60 * 1000),
                        progress: parseFloat(document.getElementById('comunidades-progress').value) || 0
                    }
                ];
                const validTasks = tasks.filter(task => task.start && task.end && !isNaN(task.start.getTime()) && !isNaN(task.end.getTime()) && task.start <= task.end);
                if (validTasks.length === 0) {
                    ganttChart.innerHTML = '<p class="error-message"><i class="fas fa-exclamation-triangle"></i> No hay hitos válidos con fechas completas para mostrar</p>';
                    return;
                }
                // Calculate total task for project duration and average progress
                const minDate = new Date(Math.min(...validTasks.map(task => task.start.getTime())));
                const maxDate = new Date(Math.max(...validTasks.map(task => task.end.getTime())));
                const averageProgress = validTasks.reduce((sum, task) => sum + task.progress, 0) / validTasks.length;
                validTasks.push({
                    name: 'Total',
                    start: minDate,
                    end: maxDate,
                    progress: averageProgress
                });
                // Adjust date range
                const startDateAdjusted = new Date(minDate);
                startDateAdjusted.setMonth(startDateAdjusted.getMonth() - 1);
                const endDateAdjusted = new Date(maxDate);
                endDateAdjusted.setMonth(endDateAdjusted.getMonth() + 1);
                const totalDays = Math.ceil((endDateAdjusted - startDateAdjusted) / (1000 * 60 * 60 * 24));
                if (totalDays <= 0) {
                    ganttChart.innerHTML = '<p class="error-message"><i class="fas fa-exclamation-triangle"></i> Rango de fechas inválido</p>';
                    return;
                }
                const dayWidth = ganttChart.offsetWidth / totalDays;
                // Create y-axis labels
                validTasks.forEach((task, index) => {
                    const label = document.createElement('div');
                    label.className = 'gantt-label';
                    label.style.top = `${index * 40 + 10}px`;
                    label.innerHTML = `<i class="fas ${getIconForTask(task.name)}"></i> ${task.name}`;
                    ganttLabels.appendChild(label);
                });
                // Create task bars and progress bars
                validTasks.forEach((task, index) => {
                    const daysFromStart = Math.ceil((task.start - startDateAdjusted) / (1000 * 60 * 60 * 24));
                    const taskDuration = Math.ceil((task.end - task.start) / (1000 * 60 * 60 * 24));
                    if (taskDuration <= 0) return;
                    const taskElement = document.createElement('div');
                    taskElement.className = `gantt-item ${task.name === 'Total' ? 'total' : ''}`;
                    taskElement.style.left = `${daysFromStart * dayWidth}px`;
                    taskElement.style.width = `${taskDuration * dayWidth}px`;
                    taskElement.style.top = `${index * 40 + 6}px`;
                    // --- MEJORA 1: Tooltip Enriquecido ---
                    const durationDays = Math.ceil((task.end - task.start) / (1000 * 60 * 60 * 24));
                    taskElement.title = `${task.name}\nInicio: ${task.start.toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit', year: '2-digit'}).replace(/\//g, '-')}\nTérmino: ${task.end.toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit', year: '2-digit'}).replace(/\//g, '-')}\nDuración: ${durationDays} días\nProgreso: ${task.progress}%`;
                    // --- MEJORA 6: Interactividad de Selección ---
                    taskElement.onclick = () => {
                        document.querySelectorAll('.gantt-item').forEach(item => item.classList.remove('active'));
                        taskElement.classList.add('active');
                    };
                    // --- MEJORA 2 & 3: Barra de progreso con etiqueta en negrita y color azul ---
                    const progressElement = document.createElement('div');
                    progressElement.className = 'gantt-progress';
                    progressElement.style.width = `${task.progress}%`;
                    // Etiqueta de porcentaje en negrita
                    const progressLabel = document.createElement('span');
                    progressLabel.className = 'gantt-progress-label';
                    progressLabel.textContent = `${Math.round(task.progress)}%`;
                    progressElement.appendChild(progressLabel);
                    taskElement.appendChild(progressElement);
                    ganttChart.appendChild(taskElement);
                });
                // --- MEJORA 5: Escala de Tiempo Adaptativa ---
                let step = 30;
                if (totalDays < 60) step = 7;
                else if (totalDays < 120) step = 14;
                for (let i = 0; i <= totalDays; i += step) {
                    const timeMarker = document.createElement('div');
                    timeMarker.style.position = 'absolute';
                    timeMarker.style.left = `${i * dayWidth}px`;
                    timeMarker.style.top = '0';
                    timeMarker.style.width = '1px';
                    timeMarker.style.height = '100%';
                    timeMarker.style.backgroundColor = '#e9ecef';
                    timeMarker.style.zIndex = '1';
                    ganttChart.appendChild(timeMarker);
                    const dateLabel = document.createElement('div');
                    dateLabel.style.position = 'absolute';
                    dateLabel.style.left = `${i * dayWidth}px`;
                    dateLabel.style.top = '5px';
                    dateLabel.style.fontSize = '12px';
                    dateLabel.style.color = '#6c757d';
                    dateLabel.style.fontWeight = '500';
                    dateLabel.style.transform = 'translateX(-50%)';
                    dateLabel.style.whiteSpace = 'nowrap';
                    dateLabel.style.textAlign = 'center';
                    const currentDate = new Date(startDateAdjusted);
                    currentDate.setDate(startDateAdjusted.getDate() + i);
                    // --- MEJORA 4: Formato "mmm-aa" ---
                    const monthNames = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
                    const month = monthNames[currentDate.getMonth()];
                    const year = currentDate.getFullYear().toString().slice(-2);
                    dateLabel.textContent = `${month}-${year}`;
                    if (ganttDates) {
                        ganttDates.appendChild(dateLabel);
                    } else {
                        ganttChart.appendChild(dateLabel);
                    }
                }
                // --- Línea de Tiempo "Hoy" ---
                const today = new Date();
                if (today >= startDateAdjusted && today <= endDateAdjusted) {
                    const daysFromStartToday = Math.ceil((today - startDateAdjusted) / (1000 * 60 * 60 * 24));
                    const todayLine = document.createElement('div');
                    todayLine.className = 'gantt-today-line';
                    todayLine.style.left = `${daysFromStartToday * dayWidth}px`;
                    todayLine.title = `Hoy: ${today.toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit', year: '2-digit'}).replace(/\//g, '-')}`;
                    ganttChart.appendChild(todayLine);
                }
                
                // --- Línea de Fecha de Control ---
                const controlDateElement = document.getElementById('control-date');
                const controlDate = controlDateElement ? controlDateElement.valueAsDate : null;
                if (controlDate && controlDate >= startDateAdjusted && controlDate <= endDateAdjusted) {
                    const daysFromStartControl = Math.ceil((controlDate - startDateAdjusted) / (1000 * 60 * 60 * 24));
                    const controlLine = document.createElement('div');
                    controlLine.className = 'gantt-current-line';
                    controlLine.style.left = `${daysFromStartControl * dayWidth}px`;
                    controlLine.title = `Fecha de Control: ${controlDate.toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit', year: '2-digit'}).replace(/\//g, '-')}`;
                    ganttChart.appendChild(controlLine);
                }
            } catch (e) {
                console.error('Error drawing Gantt chart:', e);
                document.getElementById('gantt-chart').innerHTML = `<p class="error-message"><i class="fas fa-exclamation-triangle"></i> Error al dibujar el diagrama de Gantt: ${e.message}</p>`;
            }
        }
        function getIconForTask(taskName) {
            const icons = {
                'Terreno': 'fa-landmark',
                'Conexión': 'fa-plug',
                'Línea': 'fa-route',
                'Permiso Ambiental': 'fa-tree',
                'Comunidades': 'fa-users',
                'Total': 'fa-chart-line'
            };
            return icons[taskName] || 'fa-tasks';
        }
        
        let commentScrollPositions = {};
        
        function addComment(milestone) {
            try {
                const textarea = document.getElementById(`${milestone}-comments`);
                const text = textarea.value.trim();
                if (!text) return;
                
                const projectName = document.getElementById('control-project-name-header').value;
                const controlDate = document.getElementById('control-date').value;
                
                if (!projectName || !controlDate) {
                    showNotification('Debe tener un proyecto y fecha de control para agregar comentarios.', 'warning');
                    return;
                }
                
                const historyDiv = document.getElementById(`${milestone}-comments-history`);
                const now = new Date();
                const actualDateStr = now.toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit', year: '2-digit'}).replace(/\//g, '-');
                
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment-item';
                commentDiv.setAttribute('data-control-date', controlDate);
                commentDiv.setAttribute('data-timestamp', now.getTime());
                commentDiv.innerHTML = `
                    <div class="comment-date">${actualDateStr}</div>
                    <div class="comment-text" onclick="editComment(this)">${text}</div>
                    <div class="comment-actions">
                        <button onclick="deleteComment(this.parentElement)" class="btn-delete-comment">×</button>
                    </div>
                `;
                
                historyDiv.appendChild(commentDiv);
                textarea.value = '';
                
                if (!commentScrollPositions[milestone]) commentScrollPositions[milestone] = 0;
                const comments = historyDiv.children;
                if (comments.length > 0) {
                    commentScrollPositions[milestone] = comments.length - 1;
                    showComment(milestone, commentScrollPositions[milestone]);
                }
            } catch (e) {
                console.error('Error adding comment:', e);
            }
        }
        
        function scrollComments(milestone, direction) {
            const historyDiv = document.getElementById(`${milestone}-comments-history`);
            const comments = historyDiv.children;
            if (comments.length === 0) return;
            
            if (!commentScrollPositions[milestone]) commentScrollPositions[milestone] = comments.length - 1;
            
            commentScrollPositions[milestone] += direction;
            if (commentScrollPositions[milestone] < 0) commentScrollPositions[milestone] = comments.length - 1;
            if (commentScrollPositions[milestone] >= comments.length) commentScrollPositions[milestone] = 0;
            
            showComment(milestone, commentScrollPositions[milestone]);
        }
        
        function showComment(milestone, index) {
            const historyDiv = document.getElementById(`${milestone}-comments-history`);
            const comments = historyDiv.children;
            
            for (let i = 0; i < comments.length; i++) {
                comments[i].style.display = i === index ? 'block' : 'none';
            }
        }
        
        function editComment(textElement) {
            const currentText = textElement.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            input.className = 'comment-edit-input';
            input.onblur = () => {
                textElement.textContent = input.value || currentText;
                textElement.style.display = 'block';
                input.remove();
            };
            input.onkeypress = (e) => {
                if (e.key === 'Enter') input.blur();
            };
            textElement.style.display = 'none';
            textElement.parentElement.insertBefore(input, textElement.nextSibling);
            input.focus();
        }
        
        function deleteComment(commentElement) {
            if (confirm('¿Eliminar este comentario?')) {
                commentElement.remove();
            }
        }
        
        let currentModalMilestone = '';
        let currentModalType = '';
        
        function openCommentsModal(milestone, type) {
            currentModalMilestone = milestone;
            currentModalType = type;
            
            const modal = document.getElementById('comments-modal');
            const title = document.getElementById('modal-title');
            const commentsList = document.getElementById('modal-comments-list');
            const newCommentSection = document.getElementById('modal-new-comment');
            const textarea = document.getElementById('modal-textarea');
            
            // Configurar título
            const milestoneNames = {
                'terreno': 'Terreno',
                'conexion': 'Conexión',
                'linea': 'Línea',
                'permiso': 'Permiso Ambiental',
                'comunidades': 'Comunidades'
            };
            
            if (type === 'history') {
                title.textContent = `Comentarios - ${milestoneNames[milestone]}`;
                newCommentSection.style.display = 'none';
                commentsList.style.display = 'block';
                
                // Mostrar comentarios existentes
                commentsList.innerHTML = '';
                const historyDiv = document.getElementById(`${milestone}-comments-history`);
                if (historyDiv && historyDiv.children.length > 0) {
                    const comments = Array.from(historyDiv.children);
                    // Ordenar comentarios de más nuevo a más antiguo
                    comments.sort((a, b) => {
                        const timestampA = parseInt(a.getAttribute('data-timestamp')) || 0;
                        const timestampB = parseInt(b.getAttribute('data-timestamp')) || 0;
                        return timestampB - timestampA;
                    });
                    
                    comments.forEach(comment => {
                        const dateElement = comment.querySelector('.comment-date');
                        const textElement = comment.querySelector('.comment-text');
                        
                        if (dateElement && textElement) {
                            const modalComment = document.createElement('div');
                            modalComment.className = 'modal-comment-item';
                            modalComment.innerHTML = `
                                <div class="modal-comment-date">${dateElement.textContent}</div>
                                <div class="modal-comment-text">${textElement.textContent}</div>
                            `;
                            commentsList.appendChild(modalComment);
                        }
                    });
                } else {
                    commentsList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); font-style: italic;">No hay comentarios guardados</p>';
                }
            } else {
                title.textContent = `Escribir Comentario - ${milestoneNames[milestone]}`;
                newCommentSection.style.display = 'block';
                commentsList.style.display = 'none';
                
                // Mostrar comentarios existentes en el sidebar izquierdo
                const sidebar = document.getElementById('modal-comments-sidebar');
                sidebar.innerHTML = '';
                const historyDiv = document.getElementById(`${milestone}-comments-history`);
                if (historyDiv && historyDiv.children.length > 0) {
                    const comments = Array.from(historyDiv.children);
                    comments.sort((a, b) => {
                        const timestampA = parseInt(a.getAttribute('data-timestamp')) || 0;
                        const timestampB = parseInt(b.getAttribute('data-timestamp')) || 0;
                        return timestampB - timestampA;
                    });
                    
                    comments.forEach((comment, index) => {
                        const dateElement = comment.querySelector('.comment-date');
                        const textElement = comment.querySelector('.comment-text');
                        
                        if (dateElement && textElement) {
                            const modalComment = document.createElement('div');
                            modalComment.className = 'modal-comment-item selectable-comment';
                            modalComment.setAttribute('data-comment-index', index);
                            modalComment.innerHTML = `
                                <div class="modal-comment-date">${dateElement.textContent}</div>
                                <div class="modal-comment-text">${textElement.textContent}</div>
                            `;
                            modalComment.onclick = () => selectComment(modalComment, textElement.textContent);
                            sidebar.appendChild(modalComment);
                        }
                    });
                } else {
                    sidebar.innerHTML = '<p style="text-align: center; color: var(--text-secondary); font-style: italic;">No hay comentarios guardados</p>';
                }
                
                // Prellenar con texto existente si hay
                const existingTextarea = document.getElementById(`${milestone}-comments`);
                textarea.value = existingTextarea ? existingTextarea.value : '';
            }
            
            modal.classList.add('show');
        }
        
        function refreshModalCommentsList() {
            const sidebar = document.getElementById('modal-comments-sidebar');
            sidebar.innerHTML = '';
            const historyDiv = document.getElementById(`${currentModalMilestone}-comments-history`);
            
            if (historyDiv && historyDiv.children.length > 0) {
                const comments = Array.from(historyDiv.children);
                comments.sort((a, b) => {
                    const timestampA = parseInt(a.getAttribute('data-timestamp')) || 0;
                    const timestampB = parseInt(b.getAttribute('data-timestamp')) || 0;
                    return timestampB - timestampA;
                });
                
                comments.forEach((comment, index) => {
                    const dateElement = comment.querySelector('.comment-date');
                    const textElement = comment.querySelector('.comment-text');
                    
                    if (dateElement && textElement) {
                        const modalComment = document.createElement('div');
                        modalComment.className = 'modal-comment-item selectable-comment';
                        modalComment.setAttribute('data-comment-index', index);
                        modalComment.innerHTML = `
                            <div class="modal-comment-date">${dateElement.textContent}</div>
                            <div class="modal-comment-text">${textElement.textContent}</div>
                        `;
                        modalComment.onclick = () => selectComment(modalComment, textElement.textContent);
                        sidebar.appendChild(modalComment);
                    }
                });
            } else {
                sidebar.innerHTML = '<p style="text-align: center; color: var(--text-secondary); font-style: italic;">No hay comentarios guardados</p>';
            }
        }
        
        function closeCommentsModal() {
            const modal = document.getElementById('comments-modal');
            modal.classList.remove('show');
            currentModalMilestone = '';
            currentModalType = '';
            
            // Limpiar selección
            selectedCommentElement = null;
            selectedCommentIndex = -1;
            document.getElementById('btn-delete-comment').disabled = true;
        }
        
        let selectedCommentElement = null;
        let selectedCommentIndex = -1;
        
        function selectComment(element, text) {
            // Deseleccionar comentario anterior
            if (selectedCommentElement) {
                selectedCommentElement.classList.remove('selected');
            }
            
            // Seleccionar nuevo comentario
            selectedCommentElement = element;
            selectedCommentIndex = parseInt(element.getAttribute('data-comment-index'));
            element.classList.add('selected');
            
            // Habilitar botón de borrar
            document.getElementById('btn-delete-comment').disabled = false;
            
            // Llenar textarea con el texto del comentario seleccionado
            document.getElementById('modal-textarea').value = text;
        }
        
        function addModalComment() {
            const textarea = document.getElementById('modal-textarea');
            const text = textarea.value.trim();
            
            if (!text) {
                showNotification('Por favor escribe un comentario.', 'warning');
                return;
            }
            
            // Copiar el texto al textarea original para que se guarde
            const originalTextarea = document.getElementById(`${currentModalMilestone}-comments`);
            if (originalTextarea) {
                originalTextarea.value = text;
            }
            
            const projectName = document.getElementById('control-project-name-header').value;
            const controlDate = document.getElementById('control-date').value;
            
            if (!projectName || !controlDate) {
                showNotification('Debe tener un proyecto y fecha de control para agregar comentarios.', 'warning');
                return;
            }
            
            // Crear elemento de comentario en el historial visual
            let historyDiv = document.getElementById(`${currentModalMilestone}-comments-history`);
            if (!historyDiv) {
                // Si no existe el historial, crearlo
                historyDiv = document.createElement('div');
                historyDiv.id = `${currentModalMilestone}-comments-history`;
                historyDiv.className = 'comments-history';
                document.body.appendChild(historyDiv);
            }
            
            const now = new Date();
            const actualDateStr = now.toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit', year: '2-digit'}).replace(/\//g, '-');
            
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment-item';
            commentDiv.setAttribute('data-control-date', controlDate);
            commentDiv.setAttribute('data-timestamp', now.getTime());
            commentDiv.innerHTML = `
                <div class="comment-date">${actualDateStr}</div>
                <div class="comment-text">${text}</div>
            `;
            
            historyDiv.appendChild(commentDiv);
            
            // Limpiar textarea pero mantener modal abierto
            textarea.value = '';
            
            // Actualizar la lista de comentarios en el sidebar
            refreshModalCommentsList();
        }
        
        function editSelectedComment() {
            if (selectedCommentIndex === -1) return;
            
            const textarea = document.getElementById('modal-textarea');
            const newText = textarea.value.trim();
            
            if (!newText) {
                showNotification('Por favor escribe el texto editado.', 'warning');
                return;
            }
            
            // Actualizar el comentario en el historial
            const historyDiv = document.getElementById(`${currentModalMilestone}-comments-history`);
            const comments = Array.from(historyDiv.children);
            
            // Ordenar para obtener el índice correcto
            comments.sort((a, b) => {
                const timestampA = parseInt(a.getAttribute('data-timestamp')) || 0;
                const timestampB = parseInt(b.getAttribute('data-timestamp')) || 0;
                return timestampB - timestampA;
            });
            
            if (comments[selectedCommentIndex]) {
                const textElement = comments[selectedCommentIndex].querySelector('.comment-text');
                if (textElement) {
                    textElement.textContent = newText;
                }
            }
            
            // Limpiar selección y textarea
            textarea.value = '';
            selectedCommentElement.classList.remove('selected');
            selectedCommentElement = null;
            selectedCommentIndex = -1;
            document.getElementById('btn-delete-comment').disabled = true;
            
            // Actualizar la lista
            refreshModalCommentsList();
        }
        
        function deleteSelectedComment() {
            if (selectedCommentIndex === -1) return;
            
            if (!confirm('¿Estás seguro de eliminar este comentario?')) return;
            
            // Eliminar el comentario del historial
            const historyDiv = document.getElementById(`${currentModalMilestone}-comments-history`);
            const comments = Array.from(historyDiv.children);
            
            // Ordenar para obtener el índice correcto
            comments.sort((a, b) => {
                const timestampA = parseInt(a.getAttribute('data-timestamp')) || 0;
                const timestampB = parseInt(b.getAttribute('data-timestamp')) || 0;
                return timestampB - timestampA;
            });
            
            if (comments[selectedCommentIndex]) {
                comments[selectedCommentIndex].remove();
            }
            
            // Limpiar selección y textarea
            document.getElementById('modal-textarea').value = '';
            selectedCommentElement = null;
            selectedCommentIndex = -1;
            document.getElementById('btn-delete-comment').disabled = true;
            
            // Actualizar la lista
            refreshModalCommentsList();
        }
        
        // Cerrar modal al hacer clic fuera
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('comments-modal');
            if (event.target === modal) {
                closeCommentsModal();
            }
        });
        

        function addNewEvalProject() {
            try {
                currentEvalProject = null; // Deseleccionar cualquier proyecto actual
                document.getElementById('eval-form').reset(); 
                document.querySelectorAll('#eval-project-list li').forEach(li => li.classList.remove('active')); // Quitar selección visual
                
                // Limpiar resultados y gráfico
                document.getElementById('eval-results').innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--text-secondary); font-style: italic;">Formulario listo para una nueva evaluación.</td></tr>';
                if (cashflowChart) {
                    cashflowChart.destroy();
                    cashflowChart = null;
                }
            } catch (e) {
                console.error('Error adding new eval project:', e);
                showNotification('Error al preparar el formulario para una nueva evaluación.', 'error');
            }
        }
        let isEditMode = false;
        
        function addNewControlProject() {
            try {
                clearAllFields();
                document.querySelectorAll('#control-project-list li').forEach(li => li.classList.remove('active'));
                enableFields();
                isEditMode = false;
                showNotification('Formulario listo para un nuevo proyecto de control.', 'info');
            } catch (e) {
                console.error('Error adding new control project:', e);
                showNotification('Error al preparar nuevo proyecto.', 'error');
            }
        }
        
        function clearAllFields() {
            document.getElementById('control-project-name-header').value = '';
            document.getElementById('control-date').value = '';
            document.getElementById('proyecto-start').value = '';
            document.getElementById('terreno-progress').value = '0';
            document.getElementById('terreno-start').value = '';
            document.getElementById('terreno-end').value = '';
            document.getElementById('terreno-comments').value = '';
            document.getElementById('conexion-progress').value = '0';
            document.getElementById('conexion-start').value = '';
            document.getElementById('conexion-end').value = '';
            document.getElementById('conexion-comments').value = '';
            document.getElementById('linea-progress').value = '0';
            document.getElementById('linea-start').value = '';
            document.getElementById('linea-end').value = '';
            document.getElementById('linea-comments').value = '';
            document.getElementById('permiso-progress').value = '0';
            document.getElementById('permiso-start').value = '';
            document.getElementById('permiso-end').value = '';
            document.getElementById('permiso-comments').value = '';
            document.getElementById('comunidades-progress').value = '0';
            document.getElementById('comunidades-start').value = '';
            document.getElementById('comunidades-end').value = '';
            document.getElementById('comunidades-comments').value = '';
            updateGanttChart();
        }
        
        function enableFields() {
            document.querySelectorAll('input, select, textarea').forEach(field => {
                field.disabled = false;
            });
        }
        
        function disableFields() {
            document.querySelectorAll('input, select, textarea').forEach(field => {
                field.disabled = true;
            });
        }
        
        function getCommentsHistory(milestone, currentControlDate) {
            const projectName = document.getElementById('control-project-name-header').value;
            const projects = JSON.parse(safeStorage.getItem('controlProjects') || '[]');
            const project = projects.find(p => p.name === projectName);
            const comments = [];
            
            // Obtener todos los comentarios de fechas anteriores y actuales
            if (project && project.controls) {
                const currentDate = new Date(currentControlDate);
                project.controls.forEach(control => {
                    const controlDate = new Date(control.controlDate);
                    if (controlDate <= currentDate && control[milestone] && control[milestone].commentsHistory) {
                        control[milestone].commentsHistory.forEach(comment => {
                            comments.push({
                                date: comment.date,
                                text: comment.text,
                                controlDate: comment.controlDate
                            });
                        });
                    }
                });
            }
            
            // Agregar comentarios del historial visual actual
            const historyDiv = document.getElementById(`${milestone}-comments-history`);
            if (historyDiv) {
                Array.from(historyDiv.children).forEach(commentDiv => {
                    const dateElement = commentDiv.querySelector('.comment-date');
                    const textElement = commentDiv.querySelector('.comment-text');
                    const controlDate = commentDiv.getAttribute('data-control-date');
                    
                    if (dateElement && textElement) {
                        // Evitar duplicados
                        const exists = comments.some(c => 
                            c.date === dateElement.textContent && 
                            c.text === textElement.textContent && 
                            c.controlDate === controlDate
                        );
                        if (!exists) {
                            comments.push({
                                date: dateElement.textContent,
                                text: textElement.textContent,
                                controlDate: controlDate || currentControlDate
                            });
                        }
                    }
                });
            }
            
            // Agregar nuevo comentario si existe
            const newCommentText = document.getElementById(`${milestone}-comments`);
            if (newCommentText && newCommentText.value.trim()) {
                const now = new Date();
                const dateStr = now.toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit', year: '2-digit'}).replace(/\//g, '-');
                comments.push({
                    date: dateStr,
                    text: newCommentText.value.trim(),
                    controlDate: currentControlDate
                });
            }
            
            return comments;
        }
        function saveControlProject() {
            if (!validateControlForm()) return;
            try {
                const projects = JSON.parse(safeStorage.getItem('controlProjects') || '[]');
                const name = document.getElementById('control-project-name-header').value;
                const controlDateElement = document.getElementById('control-date');
                const controlDate = controlDateElement ? controlDateElement.value : '';
                
                if (!controlDate) {
                    showNotification('Por favor ingresa la fecha de control.', 'warning');
                    return;
                }
                
                const controlData = {
                    controlDate,
                    startDate: document.getElementById('proyecto-start') ? document.getElementById('proyecto-start').value : '',
                    terreno: {
                        progress: document.getElementById('terreno-progress') ? document.getElementById('terreno-progress').value : '0',
                        start: document.getElementById('terreno-start') ? document.getElementById('terreno-start').value : '',
                        end: document.getElementById('terreno-end') ? document.getElementById('terreno-end').value : '',
                        comments: document.getElementById('terreno-comments') ? document.getElementById('terreno-comments').value : '',
                        commentsHistory: getCommentsHistory('terreno', controlDate)
                    },
                    conexion: {
                        progress: document.getElementById('conexion-progress') ? document.getElementById('conexion-progress').value : '0',
                        start: document.getElementById('conexion-start') ? document.getElementById('conexion-start').value : '',
                        end: document.getElementById('conexion-end') ? document.getElementById('conexion-end').value : '',
                        comments: document.getElementById('conexion-comments') ? document.getElementById('conexion-comments').value : '',
                        commentsHistory: getCommentsHistory('conexion', controlDate)
                    },
                    linea: {
                        progress: document.getElementById('linea-progress') ? document.getElementById('linea-progress').value : '0',
                        start: document.getElementById('linea-start') ? document.getElementById('linea-start').value : '',
                        end: document.getElementById('linea-end') ? document.getElementById('linea-end').value : '',
                        comments: document.getElementById('linea-comments') ? document.getElementById('linea-comments').value : '',
                        commentsHistory: getCommentsHistory('linea', controlDate)
                    },
                    permiso: {
                        progress: document.getElementById('permiso-progress') ? document.getElementById('permiso-progress').value : '0',
                        start: document.getElementById('permiso-start') ? document.getElementById('permiso-start').value : '',
                        end: document.getElementById('permiso-end') ? document.getElementById('permiso-end').value : '',
                        comments: document.getElementById('permiso-comments') ? document.getElementById('permiso-comments').value : '',
                        commentsHistory: getCommentsHistory('permiso', controlDate)
                    },
                    comunidades: {
                        progress: document.getElementById('comunidades-progress') ? document.getElementById('comunidades-progress').value : '0',
                        start: document.getElementById('comunidades-start') ? document.getElementById('comunidades-start').value : '',
                        end: document.getElementById('comunidades-end') ? document.getElementById('comunidades-end').value : '',
                        comments: document.getElementById('comunidades-comments') ? document.getElementById('comunidades-comments').value : '',
                        commentsHistory: getCommentsHistory('comunidades', controlDate)
                    }
                };
                
                let project = projects.find(p => p.name === name);
                if (!project) {
                    project = {
                        id: Date.now(),
                        name,
                        controls: []
                    };
                    projects.push(project);
                }
                
                const existingControlIndex = project.controls.findIndex(c => c.controlDate === controlDate);
                if (existingControlIndex > -1) {
                    project.controls[existingControlIndex] = controlData;
                } else {
                    project.controls.push(controlData);
                }
                
                safeStorage.setItem('controlProjects', JSON.stringify(projects));
                loadControlProjects();
                showNotification('Control guardado exitosamente.', 'success');
                updateGanttChart();
            } catch (e) {
                console.error('Error saving control project:', e);
                showNotification('Error al guardar el control.', 'error');
            }
        }
        function editControlProject() {
            try {
                const name = document.getElementById('control-project-name-header').value;
                if (!name) {
                    showNotification('Selecciona un proyecto para editar.', 'warning');
                    return;
                }
                enableFields();
                isEditMode = true;
                
                const formContainer = document.querySelector('.form-container');
                const successMsg = document.createElement('div');
                successMsg.className = 'success-message';
                successMsg.innerHTML = '<i class="fas fa-edit"></i> Modo edición activado. Puedes modificar los campos.';
                formContainer.prepend(successMsg);
                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.remove();
                    }
                }, 3000);
            } catch (e) {
                console.error('Error editing control project:', e);
                showNotification('Error al activar modo edición.', 'error');
            }
        }
        function deleteControlProject() {
            try {
                const name = document.getElementById('control-project-name-header').value;
                const controlDate = document.getElementById('control-date').value;
                
                if (!name) {
                    showNotification('Selecciona un proyecto para eliminar.', 'warning');
                    return;
                }
                
                if (!confirm('¿Estás seguro de que deseas eliminar este proyecto?')) return;
                
                let projects = JSON.parse(safeStorage.getItem('controlProjects') || '[]');
                projects = projects.filter(p => p.name !== name);
                safeStorage.setItem('controlProjects', JSON.stringify(projects));
                loadControlProjects();
                showNotification('Proyecto eliminado exitosamente.', 'success');
                
                document.getElementById('control-project-name-header').value = '';
                document.getElementById('control-date').value = '';
                document.getElementById('proyecto-start').value = '';
                document.querySelectorAll('.control-table input[type="number"]').forEach(input => input.value = '0');
                document.querySelectorAll('.control-table input[type="date"]').forEach(input => input.value = '');
                document.querySelectorAll('.control-table textarea').forEach(textarea => textarea.value = '');
                updateGanttChart();
            } catch (e) {
                console.error('Error deleting control project:', e);
                showNotification('Error al eliminar el proyecto.', 'error');
            }
        }
        // Event Listeners
        try {
            document.getElementById('contact-form')?.addEventListener('submit', e => {
                e.preventDefault();
                const successMsg = document.createElement('div');
                successMsg.className = 'success-message';
                successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Mensaje enviado exitosamente. Nos pondremos en contacto contigo pronto.';
                e.target.parentNode.insertBefore(successMsg, e.target.nextSibling);
                e.target.reset();
                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.remove();
                    }
                }, 5000);
            });
            document.addEventListener('DOMContentLoaded', () => {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('control-start-date').value = today;
                document.getElementById('current-date').value = today;
                loadEvalProjects();
                loadControlProjects();
                updateGanttChart();
            });
            window.addEventListener('resize', () => {
                if (document.getElementById('control').classList.contains('active')) {
                    updateGanttChart();
                }
            });
        } catch (e) {
            console.error('Error setting event listeners:', e);
            showNotification('Error al inicializar los eventos.', 'error');
        }
        // Inicializar la aplicación con login
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                login(username, password);
            });
        });
    </script>
</body>
</html>
