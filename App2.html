<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energia03 - Evaluación y Control de Proyectos de Energía</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary: #1a3a5f;          /* Azul oscuro profesional */
            --primary-light: #2c5aa0;    /* Azul medio */
            --accent: #e63946;           /* Rojo para alertas y énfasis */
            --success: #2a9d8f;          /* Verde esmeralda para éxito */
            --warning: #f4a261;          /* Naranja suave para advertencias */
            --light-bg: #f8f9fa;         /* Fondo claro */
            --light-card: #ffffff;       /* Blanco puro para tarjetas */
            --text-primary: #212529;     /* Texto oscuro */
            --text-secondary: #6c757d;   /* Texto secundario */
            --border: #e9ecef;           /* Borde suave */
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow: 0 4px 16px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
            --radius: 12px;              /* Bordes más suaves */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        html, body {
            height: 100%;
        }
        body {
            background-color: var(--light-bg);
            color: var(--text-primary);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main {
            flex: 1;
        }
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }
        /* Header Moderno */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, #122a44 100%);
            color: white;
            padding: 16px 0;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .logo h1 {
            font-size: 26px;
            font-weight: 700;
            letter-spacing: -0.5px;
            background: linear-gradient(to right, #ffffff, #a0c4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .logo-icon {
            font-size: 32px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        nav ul {
            display: flex;
            list-style: none;
            gap: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }
        nav a {
            color: rgba(255, 255, 255, 0.85);
            text-decoration: none;
            font-weight: 500;
            font-size: 15px;
            padding: 8px 16px;
            border-radius: 8px;
            transition: var(--transition);
            position: relative;
        }
        nav a:hover,
        nav a:focus {
            color: white;
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        nav a.active {
            color: white;
            background: rgba(255, 255, 255, 0.2);
            font-weight: 600;
        }
        /* Páginas y Contenedores */
        .page {
            display: none;
            padding: 32px 0;
        }
        .page.active {
            display: block;
        }
        .page-wrapper {
            display: flex;
            flex-direction: column;
            min-height: 100%;
        }
        .spacer {
            flex: 1;
        }
        /* Secciones Generales */
        .hero {
            background: linear-gradient(rgba(26, 58, 95, 0.7), rgba(26, 58, 95, 0.7)), url('https://images.unsplash.com/photo-1466611653911-95081537e5b7?ixlib=rb-4.0.3&auto=format&fit=crop&w=1400&q=80') center/cover no-repeat;
            color: white;
            text-align: center;
            padding: 80px 0;
            border-radius: var(--radius);
            margin-bottom: 40px;
            box-shadow: var(--shadow);
        }
        .hero h2 {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            letter-spacing: -1px;
        }
        .hero p {
            font-size: 20px;
            max-width: 720px;
            margin: 0 auto 32px;
            font-weight: 300;
            opacity: 0.9;
        }
        .cta-button {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary-light), #3a6ea5);
            color: white;
            padding: 16px 40px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            font-size: 18px;
            transition: var(--transition);
            box-shadow: var(--shadow);
            border: none;
            cursor: pointer;
            letter-spacing: 0.5px;
        }
        .cta-button:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: var(--shadow-lg);
            background: linear-gradient(135deg, #3a6ea5, var(--primary-light));
        }
        .section-title {
            text-align: center;
            margin-bottom: 48px;
        }
        .section-title h2 {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 16px;
            position: relative;
            display: inline-block;
            padding-bottom: 16px;
        }
        .section-title h2:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-light), var(--primary));
            border-radius: 2px;
        }
        .section-title p {
            color: var(--text-secondary);
            font-size: 18px;
            max-width: 600px;
            margin: 16px auto 0;
        }
        /* Cards y Grids */
        .services-grid,
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 32px;
            margin-bottom: 40px;
        }
        .service-card,
        .project-card {
            background: var(--light-card);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            border: 1px solid var(--border);
        }
        .service-card:hover,
        .project-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow);
            border-color: rgba(44, 90, 160, 0.3);
        }
        .service-icon {
            font-size: 56px;
            color: var(--primary-light);
            margin: 24px auto 16px;
            display: block;
        }
        .service-card h3,
        .project-content h3 {
            font-size: 22px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 16px;
            padding: 0 24px;
        }
        .service-card p,
        .project-content p {
            color: var(--text-secondary);
            margin: 0 24px 24px;
            line-height: 1.6;
        }
        .project-image {
            height: 200px;
            background-size: cover;
            background-position: center;
            background-color: var(--primary-light);
        }
        .project-link {
            display: inline-block;
            background: var(--primary-light);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            font-size: 15px;
            transition: var(--transition);
            margin: 0 24px 24px;
            border: none;
            cursor: pointer;
        }
        .project-link:hover {
            background: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        /* Quote Section */
        .quote {
            background: linear-gradient(135deg, var(--primary-light) 0%, #1a3a5f 100%);
            color: white;
            padding: 60px 0;
            text-align: center;
            border-radius: var(--radius);
            margin: 40px 0;
            box-shadow: var(--shadow-sm);
        }
        .quote blockquote {
            font-size: 28px;
            font-style: italic;
            font-weight: 300;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.5;
            position: relative;
            padding: 0 40px;
        }
        .quote blockquote:before,
        .quote blockquote:after {
            content: '"';
            font-size: 60px;
            color: rgba(255,255,255,0.3);
            position: absolute;
        }
        .quote blockquote:before {
            top: -20px;
            left: 0;
        }
        .quote blockquote:after {
            bottom: -60px;
            right: 0;
        }
        .quote cite {
            display: block;
            margin-top: 24px;
            font-size: 18px;
            font-weight: 500;
            opacity: 0.9;
        }
        /* Footer */
        footer {
            background: var(--primary);
            color: rgba(255, 255, 255, 0.8);
            padding: 24px 0;
            font-size: 14px;
            text-align: center;
            margin-top: 40px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        /* Botones Modernos */
        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 15px;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            letter-spacing: 0.3px;
        }
        .btn i {
            font-size: 16px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-light), #1a3a5f);
            color: white;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #1a3a5f, var(--primary-light));
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        .btn-success {
            background: linear-gradient(135deg, var(--success), #227e74);
            color: white;
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #227e74, var(--success));
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        .btn-danger {
            background: linear-gradient(135deg, var(--accent), #b82b37);
            color: white;
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #b82b37, var(--accent));
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, #495057, #6c757d);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        /* Formularios y Controles */
        .form-group {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .form-group label {
            font-weight: 600;
            color: var(--primary);
            font-size: 15px;
            margin-bottom: 4px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            transition: var(--transition);
            background: var(--light-card);
            color: var(--text-primary);
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        /* Evaluation & Control Specific */
        .evaluation-control-container {
            display: flex;
            gap: 32px;
            margin-top: 24px;
            flex-wrap: wrap;
        }
        .projects-sidebar {
            width: 200px;
            background: var(--light-card);
            border-radius: 0;
            padding: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            border-left: none;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 999;
            flex-shrink: 0;
            overflow-y: auto;
            font-size: 12px;
        }
        @media (max-width: 768px) {
            .projects-sidebar {
                width: 100%;
                height: auto;
                position: relative;
                margin-top: 0;
            }
            .projects-sidebar h3 {
                margin-top: 0;
            }
            .form-container {
                margin-left: 0;
            }
        }
        .projects-sidebar h3 {
            color: var(--primary);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-light);
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 80px;
        }
        .projects-sidebar h3 i {
            color: var(--primary-light);
        }
        .project-list {
            list-style: none;
            max-height: 420px;
            overflow-y: auto;
            padding-right: 8px;
        }
        .project-list li {
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }
        .project-list li:before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--border);
            border-radius: 50%;
        }
        .project-list li:hover {
            background: rgba(44, 90, 160, 0.05);
            border-color: rgba(44, 90, 160, 0.2);
        }
        .project-list li.active {
            background: var(--primary-light);
            color: white;
            border-color: var(--primary-light);
        }
        .project-list li.active:before {
            background: white;
        }
        .form-container {
            flex: 1;
            background: var(--light-card);
            border-radius: var(--radius);
            padding: 32px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin-left: 200px;
        }
        .results {
            padding: 24px;
            background: #f0f7ff;
            border-radius: var(--radius);
            border: 1px solid #c2e0ff;
            font-size: 16px;
            font-weight: 500;
            color: var(--primary);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .results p {
            margin: 8px 0;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .results p strong {
            font-weight: 600;
            color: var(--primary);
        }
        .chart-container {
            height: 320px;
            position: relative;
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid var(--border);
        }
        .buttons {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            padding-top: 16px;
            border-top: 2px dashed var(--border);
        }
        /* Progress Bars */
        .progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        .progress-item {
            background: var(--light-card);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            transition: var(--transition);
        }
        .progress-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
        }
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .progress-title {
            font-weight: 600;
            color: var(--primary);
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .progress-title i {
            color: var(--primary-light);
            font-size: 18px;
        }
        .progress-bar {
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-light), var(--primary));
            border-radius: 6px;
            transition: width 0.5s ease;
        }
        .progress-value {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: var(--text-secondary);
        }
        .progress-value input[type="number"] {
            width: 60px;
            text-align: center;
            font-weight: 600;
            color: var(--primary);
        }
        /* Gantt Chart */
        .gantt-container {
            margin-top: 32px;
            background: var(--light-card);
            padding: 32px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }
        .gantt-container h4 {
            color: var(--primary);
            margin-bottom: 24px;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .gantt-container h4 i {
            color: var(--primary-light);
        }
        .gantt-wrapper {
            display: flex;
            position: relative;
            gap: 16px;
        }
        .gantt-labels {
            width: 180px;
            flex-shrink: 0;
        }
        .gantt-label {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
            font-weight: 600;
            color: var(--primary);
            padding-left: 16px;
            font-size: 15px;
            border-bottom: 1px solid var(--border);
        }
        .gantt-chart {
            flex: 1;
            height: 280px;
            position: relative;
            border-left: 2px solid var(--border);
            border-bottom: 2px solid var(--border);
            background: #fafafa;
            border-radius: 0 8px 8px 0;
            overflow: hidden;
        }
        .gantt-item {
            position: absolute;
            height: 28px;
            /* --- MODIFICACIÓN: Fondo claro para la barra de duración total --- */
            background: #e9ecef; /* Gris claro */
            border: 1px solid #ced4da; /* Borde sutil */
            border-radius: 4px;
            top: 6px;
            transition: var(--transition);
        }
        .gantt-item.total {
            background: #e9ecef;
            border-color: #adb5bd;
        }
        .gantt-item:hover {
            transform: scaleY(1.1);
            z-index: 10;
        }
        .gantt-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            /* --- MODIFICACIÓN: Color azul para la barra de avance --- */
            background: var(--primary-light); /* Azul que destaca */
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        /* --- MODIFICACIÓN: Estilo para la etiqueta de porcentaje en negrita --- */
        .gantt-progress-label {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: 700; /* Negrita */
            color: #111;      /* Color negro */
            text-shadow: 0 0 2px rgba(0,0,0,0.5);
            z-index: 5;
        }
        .gantt-today-line {
            position: absolute;
            top: 0;
            width: 2px;
            height: 100%;
            background: var(--accent); /* Rojo para destacar */
            z-index: 5;
        }
        /* Contact Form */
        #contact-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 520px;
            margin: 0 auto;
        }
        #contact-form .btn {
            align-self: center;
            margin-top: 16px;
        }
        /* Error & Success Messages */
        .error-message {
            color: var(--accent);
            background: #fef2f2;
            border: 1px solid #fecaca;
            padding: 16px;
            border-radius: var(--radius);
            margin: 16px 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .error-message i {
            font-size: 20px;
        }
        .success-message {
            color: var(--success);
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            padding: 16px;
            border-radius: var(--radius);
            margin: 16px 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .success-message i {
            font-size: 20px;
        }
        /* Responsive Design */
        @media (max-width: 1024px) {
            .container {
                padding: 0 16px;
            }
            .hero {
                padding: 60px 0;
            }
            .hero h2 {
                font-size: 36px;
            }
            .section-title h2 {
                font-size: 32px;
            }
        }
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 16px;
            }
            nav ul {
                gap: 8px;
                justify-content: center;
            }
            .hero h2 {
                font-size: 32px;
            }
            .hero p {
                font-size: 18px;
                margin-bottom: 24px;
            }
            .evaluation-control-container {
                flex-direction: column;
            }
            .projects-sidebar {
                width: 100%;
            }
            .form-grid,
            .progress-grid {
                grid-template-columns: 1fr;
            }
            .gantt-wrapper {
                flex-direction: column;
            }
            .gantt-labels {
                width: 100%;
                border-bottom: 2px solid var(--border);
                padding-bottom: 16px;
                margin-bottom: 16px;
            }
            .gantt-label {
                justify-content: flex-start;
                padding-left: 16px;
                padding-right: 0;
            }
            .gantt-chart {
                border-radius: 8px;
                border-left: none;
            }
        }
        @media (max-width: 480px) {
            .hero {
                padding: 40px 0;
            }
            .hero h2 {
                font-size: 28px;
            }
            .section-title h2 {
                font-size: 28px;
            }
            .services-grid,
            .projects-grid {
                grid-template-columns: 1fr;
                gap: 24px;
            }
            .form-container {
                padding: 24px;
            }
            .buttons {
                flex-direction: column;
            }
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
        /* Control Table Styles */
        .control-table {
            width: 100%;
            border-collapse: collapse;
            margin: 24px 0;
            background: var(--light-card);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }
        .control-table thead {
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: white;
        }
        .control-table th {
            padding: 16px 12px;
            font-weight: 600;
            font-size: 15px;
            text-align: left;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }
        .control-table tbody tr {
            border-bottom: 1px solid #e3f2fd;
            transition: var(--transition);
        }
        .control-table tbody tr:nth-child(odd) {
            background: linear-gradient(90deg, #f8fbff 0%, #ffffff 100%);
        }
        .control-table tbody tr:nth-child(even) {
            background: linear-gradient(90deg, #f0f8ff 0%, #fafcff 100%);
        }
        .control-table tbody tr:hover {
            background: linear-gradient(90deg, #e3f2fd 0%, #f3f9ff 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(44, 90, 160, 0.1);
        }
        .control-table td {
            padding: 16px 12px;
            vertical-align: top;
            border-right: 1px solid #e8f4fd;
        }
        .control-table td:last-child {
            border-right: none;
        }
        .hito-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--primary);
            font-size: 15px;
        }
        .hito-title i {
            color: var(--primary-light);
            font-size: 16px;
        }
        .date-inputs {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .date-inputs input[type="date"] {
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            background: white;
            transition: var(--transition);
        }
        .date-inputs input[type="date"]:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.1);
        }
        .progress-cell {
            text-align: center;
        }
        .progress-cell input[type="number"] {
            width: 70px;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
            color: var(--primary);
            background: white;
            transition: var(--transition);
        }
        .progress-cell input[type="number"]:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.1);
        }
        .comments-cell textarea {
            width: 100%;
            min-height: 60px;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
            background: white;
            transition: var(--transition);
        }
        .comments-cell textarea:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.1);
        }
        .comments-cell textarea::placeholder {
            color: var(--text-secondary);
            font-style: italic;
        }
        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .page.active {
            animation: fadeInUp 0.6s ease-out;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-bolt logo-icon"></i>
                    <h1>Energia03</h1>
                </div>
                <nav>
                    <ul>
                        <li><a href="#" onclick="showPage('inicio'); return false;">Inicio</a></li>
                        <li><a href="#" onclick="showPage('servicios'); return false;">Servicios</a></li>
                        <li><a href="#" onclick="showPage('proyectos'); return false;">Proyectos</a></li>
                        <li><a href="#" onclick="showPage('evaluacion'); return false;">Evaluación</a></li>
                        <li><a href="#" onclick="showPage('control'); return false;">Control</a></li>
                        <li><a href="#" onclick="showPage('contacto'); return false;">Contacto</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>
    <main>
        <!-- PÁGINA DE INICIO -->
        <div id="inicio" class="page active">
            <div class="page-wrapper">
                <section class="hero">
                    <div class="container">
                        <h2>Energía03 - Herramienta de Evaluación y Control</h2>
                        <p>Plataforma integral para gestionar y maximizar el valor de tus proyectos energéticos</p>
                        <a href="#" onclick="showPage('evaluacion'); return false;" class="cta-button">
                            <i class="fas fa-calculator"></i> Evaluar Proyecto
                        </a>
                    </div>
                </section>
                <section class="quote">
                    <div class="container">
                        <blockquote>
                            "Lo que no se mide, no se puede mejorar. Lo que no se controla, no se puede gestionar."
                        </blockquote>
                        <cite>- Filosofía de Energia03</cite>
                    </div>
                </section>
                <div class="spacer"></div>
            </div>
        </div>
        <!-- PÁGINA DE SERVICIOS -->
        <div id="servicios" class="page">
            <div class="page-wrapper">
                <div class="container">
                    <div class="section-title">
                        <h2>Nuestros Servicios</h2>
                        <p>Soluciones integrales para la gestión de proyectos energéticos</p>
                    </div>
                    <div class="services-grid">
                        <div class="service-card">
                            <i class="fas fa-plus-circle service-icon"></i>
                            <h3>Compra de Proyectos</h3>
                            <p>Adquisición estratégica de proyectos energéticos con alto potencial de rentabilidad y crecimiento sostenible.</p>
                            <a href="#" class="project-link">Más información</a>
                        </div>
                        <div class="service-card">
                            <i class="fas fa-solar-panel service-icon"></i>
                            <h3>Nuevos Proyectos</h3>
                            <p>Desarrollo de iniciativas innovadoras en energía renovable y convencional, con enfoque en sostenibilidad.</p>
                            <a href="#" class="project-link">Más información</a>
                        </div>
                        <div class="service-card">
                            <i class="fas fa-building service-icon"></i>
                            <h3>Proyectos Propios</h3>
                            <p>Gestión integral y optimización de proyectos de energía de cartera propia para maximizar su valor.</p>
                            <a href="#" class="project-link">Más información</a>
                        </div>
                        <div class="service-card">
                            <i class="fas fa-chart-line service-icon"></i>
                            <h3>Control del Desarrollo</h3>
                            <p>Seguimiento continuo y en tiempo real del avance y desempeño de todos tus proyectos energéticos.</p>
                            <a href="#" class="project-link">Más información</a>
                        </div>
                        <div class="service-card">
                            <i class="fas fa-file-alt service-icon"></i>
                            <h3>Reportes Detallados</h3>
                            <p>Generación de informes exhaustivos y personalizados para una toma de decisiones informada y estratégica.</p>
                            <a href="#" class="project-link">Más información</a>
                        </div>
                        <div class="service-card">
                            <i class="fas fa-cogs service-icon"></i>
                            <h3>Gestión de Valor</h3>
                            <p>Maximización del valor de los proyectos mediante estrategias de control y optimización efectivas.</p>
                            <a href="#" class="project-link">Más información</a>
                        </div>
                    </div>
                </div>
                <div class="spacer"></div>
            </div>
        </div>
        <!-- PÁGINA DE PROYECTOS -->
        <div id="proyectos" class="page">
            <div class="page-wrapper">
                <div class="container">
                    <div class="section-title">
                        <h2>Nuestros Proyectos</h2>
                        <p>Proyectos destacados que hemos desarrollado y gestionado con éxito</p>
                    </div>
                    <div class="projects-grid">
                        <div class="project-card">
                            <div class="project-image" style="background-color: #3498db;"></div>
                            <div class="project-content">
                                <h3>Parque Solar Valle Verde</h3>
                                <p>Instalación de 50MW de capacidad solar fotovoltaica en terrenos recuperados, con impacto ambiental positivo.</p>
                                <a href="#" class="project-link">Ver detalles</a>
                            </div>
                        </div>
                        <div class="project-card">
                            <div class="project-image" style="background-color: #2c3e50;"></div>
                            <div class="project-content">
                                <h3>Parque Eólico Costa Norte</h3>
                                <p>Desarrollo de 30 turbinas eólicas con capacidad total de 90MW, aprovechando los vientos costeros.</p>
                                <a href="#" class="project-link">Ver detalles</a>
                            </div>
                        </div>
                        <div class="project-card">
                            <div class="project-image" style="background-color: #e74c3c;"></div>
                            <div class="project-content">
                                <h3>Central Hidroeléctrica Río Azul</h3>
                                <p>Modernización de infraestructura hidroeléctrica con aumento del 40% en eficiencia y menor impacto ambiental.</p>
                                <a href="#" class="project-link">Ver detalles</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="spacer"></div>
            </div>
        </div>
        <!-- PÁGINA DE CONTACTO -->
        <div id="contacto" class="page">
            <div class="page-wrapper">
                <div class="container">
                    <div class="section-title">
                        <h2>Contáctanos</h2>
                        <p>Estamos aquí para ayudarte a llevar tus proyectos energéticos al siguiente nivel</p>
                    </div>
                    <div style="max-width: 800px; margin: 0 auto;">
                        <div style="background: var(--light-card); padding: 40px; border-radius: var(--radius); box-shadow: var(--shadow-sm); margin-bottom: 40px; border: 1px solid var(--border);">
                            <h3 style="font-size: 24px; margin-bottom: 24px; color: var(--primary); display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-info-circle"></i> Información de Contacto
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: 16px; text-align: left; max-width: 500px; margin: 0 auto;">
                                <p><i class="fas fa-map-marker-alt" style="color: var(--primary-light); margin-right: 12px;"></i> <strong>Dirección:</strong> Av. Energía 123, Ciudad Energética</p>
                                <p><i class="fas fa-phone" style="color: var(--primary-light); margin-right: 12px;"></i> <strong>Teléfono:</strong> +123 456 7890</p>
                                <p><i class="fas fa-envelope" style="color: var(--primary-light); margin-right: 12px;"></i> <strong>Email:</strong> info@energia03.com</p>
                                <p><i class="fas fa-clock" style="color: var(--primary-light); margin-right: 12px;"></i> <strong>Horario:</strong> Lunes a Viernes: 9:00 - 18:00</p>
                            </div>
                        </div>
                        <div style="background: var(--light-card); padding: 40px; border-radius: var(--radius); box-shadow: var(--shadow-sm); border: 1px solid var(--border);">
                            <h3 style="font-size: 24px; margin-bottom: 24px; color: var(--primary); display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-envelope"></i> Formulario de Contacto
                            </h3>
                            <form id="contact-form">
                                <div class="form-group">
                                    <label for="contact-name">Nombre completo</label>
                                    <input type="text" id="contact-name" placeholder="Ingresa tu nombre completo" required>
                                </div>
                                <div class="form-group">
                                    <label for="contact-email">Correo electrónico</label>
                                    <input type="email" id="contact-email" placeholder="Ingresa tu correo electrónico" required>
                                </div>
                                <div class="form-group">
                                    <label for="contact-subject">Asunto</label>
                                    <input type="text" id="contact-subject" placeholder="¿Sobre qué deseas contactarnos?" required>
                                </div>
                                <div class="form-group">
                                    <label for="contact-message">Mensaje</label>
                                    <textarea id="contact-message" placeholder="Cuéntanos cómo podemos ayudarte..." rows="5" style="resize: vertical;" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> Enviar Mensaje
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="spacer"></div>
            </div>
        </div>
        <!-- PÁGINA DE EVALUACIÓN -->
        <div id="evaluacion" class="page">
            <div class="page-wrapper">
                <div class="container">
                    <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 24px; text-align: center;"><i class="fas fa-calculator"></i> Evaluación de Proyectos</h2>
                    <div class="evaluation-control-container">
                        <aside class="projects-sidebar">
                            <h3><i class="fas fa-folder"></i> Proyectos</h3>
                            <ul class="project-list" id="eval-project-list"></ul>
                        </aside>
                        <div class="form-container">
                            <form id="eval-form">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="eval-name"><i class="fas fa-tag"></i> Nombre del Proyecto</label>
                                        <input type="text" id="eval-name" placeholder="Nombre del proyecto" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="eval-location"><i class="fas fa-map-marker-alt"></i> Ubicación</label>
                                        <input type="text" id="eval-location" placeholder="Ubicación del proyecto" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="eval-tech"><i class="fas fa-cogs"></i> Tecnología</label>
                                        <select id="eval-tech" required>
                                            <option value="">Selecciona una tecnología</option>
                                            <option value="Solar">Solar Fotovoltaica</option>
                                            <option value="Eólica">Eólica</option>
                                            <option value="Hidroeléctrica">Hidroeléctrica</option>
                                            <option value="Biomasa">Biomasa</option>
                                            <option value="Geotérmica">Geotérmica</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="eval-capex"><i class="fas fa-dollar-sign"></i> Capex (mUSD)</label>
                                        <input type="number" id="eval-capex" min="0" step="0.01" placeholder="Costo de inversión inicial" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="eval-opex"><i class="fas fa-chart-line"></i> Opex (mUSD/año)</label>
                                        <input type="number" id="eval-opex" min="0" step="0.01" placeholder="Costos operativos anuales" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="eval-price"><i class="fas fa-bolt"></i> Precio Energía (USD/MWh)</label>
                                        <input type="number" id="eval-price" min="0" step="0.01" placeholder="Precio de venta de energía" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="eval-period"><i class="fas fa-calendar-alt"></i> Plazo de Evaluación (años)</label>
                                        <input type="number" id="eval-period" min="1" step="1" placeholder="Horizonte de evaluación" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="eval-discount"><i class="fas fa-percentage"></i> Tasa de Descuento (%)</label>
                                        <input type="number" id="eval-discount" min="0" step="0.01" placeholder="Tasa de descuento" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="eval-production"><i class="fas fa-industry"></i> Producción Anual (MWh)</label>
                                        <input type="number" id="eval-production" min="0" step="0.01" placeholder="Producción estimada anual" required>
                                    </div>
                                </div>
                            </form>
                            <div class="results" id="eval-results">
                                <p>Completa el formulario y haz clic en "Evaluar" para ver los resultados.</p>
                            </div>
                            <div class="chart-container">
                                <canvas id="cashflow-chart"></canvas>
                            </div>
                            <div class="buttons">
                                <button class="btn btn-primary" onclick="calculateEval()">
                                    <i class="fas fa-calculator"></i> Evaluar
                                </button>
                                <button class="btn btn-success" onclick="saveEvalProject()">
                                    <i class="fas fa-save"></i> Guardar
                                </button>
                                <button class="btn btn-secondary" onclick="editEvalProject()">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn btn-danger" onclick="deleteEvalProject()">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="spacer"></div>
            </div>
        </div>
        <!-- PÁGINA DE CONTROL -->
        <div id="control" class="page">
            <div class="page-wrapper">
                <div class="container">
                    <h2 style="font-size: 24px; color: var(--primary); margin-bottom: 24px; text-align: center;"><i class="fas fa-tasks"></i> Control de Proyectos</h2>
                    <div class="evaluation-control-container">
                        <div class="projects-sidebar">
                            <h3><i class="fas fa-folder"></i> Proyectos</h3>
                            <ul class="project-list" id="control-project-list"></ul>
                            <button class="btn btn-primary" style="margin-top: 20px; width: 100%;" onclick="addNewControlProject()">
                                <i class="fas fa-plus"></i> Nuevo Proyecto
                            </button>
                        </div>
                        <div class="form-container">
                            <h3 style="margin-bottom: 24px; color: var(--primary); display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-chart-bar"></i> Control de Avance
                            </h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="control-project-name"><i class="fas fa-project-diagram"></i> Nombre del Proyecto</label>
                                    <input type="text" id="control-project-name" placeholder="Nombre del proyecto" oninput="updateGanttChart()">
                                </div>
                                <div class="form-group">
                                    <label for="control-start-date"><i class="fas fa-calendar-day"></i> Fecha de Inicio del Proyecto</label>
                                    <input type="date" id="control-start-date" onchange="updateGanttChart()">
                                </div>
                            </div>
                            <!-- --- INICIO: Nueva Tabla de Control --- -->
                            <table class="control-table">
                                <thead>
                                    <tr>
                                        <th style="width: 20%;">Hito</th>
                                        <th style="width: 20%; text-align: center;">Fechas (Inicio/Fin)</th>
                                        <th style="width: 25%; text-align: center;">Estado (%)</th>
                                        <th style="width: 25%;">Comentarios</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Terreno -->
                                    <tr>
                                        <td><div class="hito-title"><i class="fas fa-landmark"></i> Terreno</div></td>
                                        <td>
                                            <div class="date-inputs">
                                               <input type="date" id="terreno-start" onchange="updateGanttChart()">
                                                <input type="date" id="terreno-end" onchange="updateGanttChart()">
                                            </div>
                                        </td>
                                        <td class="progress-cell">
                                            <input type="number" id="terreno-progress" min="0" max="100" value="0" oninput="updateProgress('terreno', this.value)">
                                        </td>
                                        <td class="comments-cell"><textarea id="terreno-comments" placeholder="Añadir comentarios..."></textarea></td>
                                    </tr>
                                    <!-- Conexión -->
                                    <tr>
                                        <td><div class="hito-title"><i class="fas fa-plug"></i> Conexión</div></td>
                                        <td>
                                            <div class="date-inputs">
                                                <input type="date" id="conexion-start" onchange="updateGanttChart()">
                                                <input type="date" id="conexion-end" onchange="updateGanttChart()">
                                            </div>
                                        </td>
                                        <td class="progress-cell">
                                            <input type="number" id="conexion-progress" min="0" max="100" value="0" oninput="updateProgress('conexion', this.value)">
                                        </td>
                                        <td class="comments-cell"><textarea id="conexion-comments" placeholder="Añadir comentarios..."></textarea></td>
                                    </tr>
                                    <!-- Línea -->
                                    <tr>
                                        <td><div class="hito-title"><i class="fas fa-route"></i> Línea</div></td>
                                        <td>
                                            <div class="date-inputs">
                                                <input type="date" id="linea-start" onchange="updateGanttChart()">
                                                <input type="date" id="linea-end" onchange="updateGanttChart()">
                                            </div>
                                        </td>
                                        <td class="progress-cell">
                                            <input type="number" id="linea-progress" min="0" max="100" value="0" oninput="updateProgress('linea', this.value)">
                                        </td>
                                        <td class="comments-cell"><textarea id="linea-comments" placeholder="Añadir comentarios..."></textarea></td>
                                    </tr>
                                    <!-- Permiso Ambiental -->
                                    <tr>
                                        <td><div class="hito-title"><i class="fas fa-tree"></i> Permiso Ambiental</div></td>
                                        <td>
                                            <div class="date-inputs">
                                                <input type="date" id="permiso-start" onchange="updateGanttChart()">
                                                <input type="date" id="permiso-end" onchange="updateGanttChart()">
                                            </div>
                                        </td>
                                        <td class="progress-cell">
                                            <input type="number" id="permiso-progress" min="0" max="100" value="0" oninput="updateProgress('permiso', this.value)">
                                        </td>
                                        <td class="comments-cell"><textarea id="permiso-comments" placeholder="Añadir comentarios..."></textarea></td>
                                    </tr>
                                    <!-- Comunidades -->
                                    <tr>
                                        <td><div class="hito-title"><i class="fas fa-users"></i> Comunidades</div></td>
                                        <td>
                                            <div class="date-inputs">
                                                <input type="date" id="comunidades-start" onchange="updateGanttChart()">
                                                <input type="date" id="comunidades-end" onchange="updateGanttChart()">
                                            </div>
                                        </td>
                                        <td class="progress-cell">
                                            <input type="number" id="comunidades-progress" min="0" max="100" value="0" oninput="updateProgress('comunidades', this.value)">
                                        </td>
                                        <td class="comments-cell"><textarea id="comunidades-comments" placeholder="Añadir comentarios..."></textarea></td>
                                    </tr>
                                </tbody>
                            </table>
                            <!-- --- FIN: Nueva Tabla de Control --- -->

                            <div class="gantt-container">
                                <h4><i class="fas fa-chart-gantt"></i> Cronograma - Diagrama de Gantt</h4>
                                <div class="gantt-wrapper">
                                    <div class="gantt-labels" id="gantt-labels"></div>
                                    <div class="gantt-chart" id="gantt-chart"></div>
                                </div>
                            </div>
                            <div class="buttons">
                                <button class="btn btn-success" onclick="saveControlProject()">
                                    <i class="fas fa-save"></i> Guardar Proyecto
                                </button>
                                <button class="btn btn-secondary" onclick="editControlProject()">
                                    <i class="fas fa-edit"></i> Editar Proyecto
                                </button>
                                <button class="btn btn-danger" onclick="deleteControlProject()">
                                    <i class="fas fa-trash"></i> Eliminar Proyecto
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="spacer"></div>
            </div>
        </div>
    </main>
    <footer>
        <div class="container">
            © 2025 Energia03 - Todos los derechos reservados
        </div>
    </footer>
    <script>
        // Fallback for localStorage
        let mockStorage = {};
        const safeStorage = {
            getItem: key => {
                try {
                    return localStorage.getItem(key) || mockStorage[key] || null;
                } catch (e) {
                    console.error('Storage get error:', e);
                    return mockStorage[key] || null;
                }
            },
            setItem: (key, value) => {
                try {
                    localStorage.setItem(key, value);
                    mockStorage[key] = value;
                } catch (e) {
                    console.error('Storage set error:', e);
                    mockStorage[key] = value;
                }
            }
        };
        let currentEvalProject = null;
        let currentControlProject = null;
        let cashflowChart = null;
        function showPage(pageId) {
            try {
                document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                const page = document.getElementById(pageId);
                if (!page) throw new Error(`Page ${pageId} not found`);
                page.classList.add('active');
                window.scrollTo(0, 0);
                // Highlight active nav link
                document.querySelectorAll('nav a').forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('onclick').includes(pageId)) {
                        link.classList.add('active');
                    }
                });
                if (pageId === 'evaluacion') {
                    loadEvalProjects();
                    document.getElementById('eval-form')?.reset();
                    document.getElementById('eval-results').innerHTML = '<p>Completa el formulario y haz clic en "Evaluar" para ver los resultados.</p>';
                    if (cashflowChart) {
                        cashflowChart.destroy();
                        cashflowChart = null;
                    }
                } else if (pageId === 'control') {
                    loadControlProjects();
                    document.getElementById('control-project-name').value = '';
                    document.getElementById('control-start-date').value = '';
                    document.querySelectorAll('.progress-item input[type="number"]').forEach(input => input.value = '0');
                    document.querySelectorAll('.progress-item input[type="date"]').forEach(input => input.value = '');
                    document.querySelectorAll('.control-table textarea').forEach(textarea => textarea.value = '');
                    document.querySelectorAll('.progress-fill').forEach(bar => bar.style.width = '0%');
                    updateGanttChart();
                }
            } catch (e) {
                console.error('Error in showPage:', e);
                alert('Error al cambiar de página');
            }
        }
        // Evaluación Functions
        function loadEvalProjects() {
            try {
                const projects = JSON.parse(safeStorage.getItem('evalProjects') || '[]');
                const list = document.getElementById('eval-project-list');
                if (!list) throw new Error('Eval project list not found');
                list.innerHTML = '';
                projects.forEach(project => {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="fas fa-file-alt"></i> ${project.name || 'Proyecto sin nombre'}`;
                    li.onclick = () => selectEvalProject(project);
                    if (project.id === currentEvalProject) li.classList.add('active');
                    list.appendChild(li);
                });
            } catch (e) {
                console.error('Error loading eval projects:', e);
                document.getElementById('eval-project-list').innerHTML = '<li class="error-message"><i class="fas fa-exclamation-triangle"></i> Error al cargar proyectos</li>';
            }
        }
        function selectEvalProject(project) {
            try {
                if (!project) throw new Error('Invalid project selected');
                currentEvalProject = project.id;
                document.querySelectorAll('#eval-project-list li').forEach(li => li.classList.remove('active'));
                const selectedLi = Array.from(document.querySelectorAll('#eval-project-list li')).find(li => li.textContent.includes(project.name));
                if (selectedLi) selectedLi.classList.add('active');
                document.getElementById('eval-name').value = project.name || '';
                document.getElementById('eval-location').value = project.location || '';
                document.getElementById('eval-tech').value = project.tech || '';
                document.getElementById('eval-capex').value = project.capex || '';
                document.getElementById('eval-opex').value = project.opex || '';
                document.getElementById('eval-price').value = project.price || '';
                document.getElementById('eval-period').value = project.period || '';
                document.getElementById('eval-discount').value = project.discount || '';
                document.getElementById('eval-production').value = project.production || '';
                document.getElementById('eval-results').innerHTML = '<p>Proyecto cargado. Haz clic en "Evaluar" para ver los resultados actualizados.</p>';
                if (cashflowChart) {
                    cashflowChart.destroy();
                    cashflowChart = null;
                }
            } catch (e) {
                console.error('Error selecting eval project:', e);
                alert('Error al seleccionar el proyecto');
            }
        }
        function validateEvalForm() {
            try {
                const inputs = [
                    { id: 'eval-name', label: 'Nombre' },
                    { id: 'eval-location', label: 'Ubicación' },
                    { id: 'eval-tech', label: 'Tecnología' },
                    { id: 'eval-capex', label: 'Capex', numeric: true },
                    { id: 'eval-opex', label: 'Opex', numeric: true },
                    { id: 'eval-price', label: 'Precio Energía', numeric: true },
                    { id: 'eval-period', label: 'Plazo de Evaluación', numeric: true, min: 1 },
                    { id: 'eval-discount', label: 'Tasa de Descuento', numeric: true },
                    { id: 'eval-production', label: 'Producción Anual', numeric: true }
                ];
                const errors = [];
                for (const input of inputs) {
                    const element = document.getElementById(input.id);
                    if (!element) throw new Error(`Input ${input.id} not found`);
                    const value = element.value;
                    if (!value) {
                        errors.push(`<i class="fas fa-exclamation-circle"></i> ${input.label} es requerido`);
                    } else if (input.numeric && (isNaN(value) || parseFloat(value) < (input.min || 0))) {
                        errors.push(`<i class="fas fa-exclamation-circle"></i> ${input.label} debe ser un número válido ${input.min ? `≥ ${input.min}` : '≥ 0'}`);
                    }
                }
                if (errors.length > 0) {
                    document.getElementById('eval-results').innerHTML = `<div class="error-message">${errors.join('<br>')}</div>`;
                    return false;
                }
                return true;
            } catch (e) {
                console.error('Error validating eval form:', e);
                document.getElementById('eval-results').innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Error al validar el formulario</div>';
                return false;
            }
        }
        function calculateEval() {
            if (!validateEvalForm()) return;
            try {
                const capex = parseFloat(document.getElementById('eval-capex').value);
                const opex = parseFloat(document.getElementById('eval-opex').value);
                const price = parseFloat(document.getElementById('eval-price').value);
                const period = parseInt(document.getElementById('eval-period').value);
                const discount = parseFloat(document.getElementById('eval-discount').value) / 100;
                const production = parseFloat(document.getElementById('eval-production').value);
                let cashflows = [-capex];
                let npv = -capex;
                for (let i = 1; i <= period; i++) {
                    const revenue = production * price / 1000;
                    const cf = revenue - opex;
                    cashflows.push(cf);
                    npv += cf / Math.pow(1 + discount, i);
                }
                const results = document.getElementById('eval-results');
                if (!results) throw new Error('Results element not found');
                const irr = calculateIRR(cashflows);
                results.innerHTML = `
                    <p><strong>Valor Presente Neto (VPN):</strong> <span style="color: ${npv >= 0 ? 'var(--success)' : 'var(--accent)'}; font-weight: 600;">${npv.toFixed(2)} mUSD</span></p>
                    <p><strong>Tasa Interna de Retorno (TIR):</strong> <span style="color: ${irr >= (discount * 100) ? 'var(--success)' : 'var(--accent)'}; font-weight: 600;">${irr.toFixed(2)} %</span></p>
                    <p><strong>Payback:</strong> ${calculatePayback(cashflows)} años</p>
                `;
                if (!window.Chart) throw new Error('Chart.js not loaded');
                const canvas = document.getElementById('cashflow-chart');
                if (!canvas || !canvas.getContext('2d')) throw new Error('Canvas not supported');
                if (cashflowChart) {
                    cashflowChart.destroy();
                    cashflowChart = null;
                }
                cashflowChart = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: period + 1}, (_, i) => `Año ${i}`),
                        datasets: [{
                            label: 'Flujo de Caja (mUSD)',
                            data: cashflows,
                            borderColor: '#2c5aa0',
                            backgroundColor: 'rgba(44, 90, 160, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointBackgroundColor: '#2c5aa0',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#212529',
                                    font: {
                                        size: 14,
                                        weight: '500'
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(44, 90, 160, 0.9)',
                                titleColor: '#ffffff',
                                bodyColor: '#ffffff',
                                borderColor: '#ffffff',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'mUSD',
                                    color: '#212529',
                                    font: {
                                        size: 14,
                                        weight: '500'
                                    }
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                },
                                ticks: {
                                    color: '#6c757d'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Año',
                                    color: '#212529',
                                    font: {
                                        size: 14,
                                        weight: '500'
                                    }
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                },
                                ticks: {
                                    color: '#6c757d'
                                }
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('Error calculating evaluation:', e);
                document.getElementById('eval-results').innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Error al calcular evaluación</div>';
            }
        }
        function calculateIRR(cashflows) {
            try {
                let irr = 0.1;
                let npv = 0;
                const maxIterations = 1000;
                const precision = 0.00001;
                for (let i = 0; i < maxIterations; i++) {
                    npv = cashflows.reduce((sum, cf, t) => sum + cf / Math.pow(1 + irr, t), 0);
                    if (Math.abs(npv) < precision) break;
                    const derivative = cashflows.reduce((sum, cf, t) => t > 0 ? sum - t * cf / Math.pow(1 + irr, t + 1) : sum, 0);
                    irr -= npv / derivative;
                }
                return irr * 100;
            } catch (e) {
                console.error('Error calculating IRR:', e);
                return 0;
            }
        }
        function calculatePayback(cashflows) {
            try {
                let cumulative = 0;
                for (let i = 0; i < cashflows.length; i++) {
                    cumulative += cashflows[i];
                    if (cumulative >= 0) {
                        if (i === 0) return 0;
                        const fraction = (cumulative - cashflows[i]) / cashflows[i];
                        return (i - 1 + fraction).toFixed(1);
                    }
                }
                return "N/A";
            } catch (e) {
                console.error('Error calculating payback:', e);
                return "N/A";
            }
        }
        function saveEvalProject() {
            if (!validateEvalForm()) return;
            try {
                const projects = JSON.parse(safeStorage.getItem('evalProjects') || '[]');
                const name = document.getElementById('eval-name').value;
                const projectData = {
                    id: currentEvalProject || Date.now(),
                    name,
                    location: document.getElementById('eval-location').value,
                    tech: document.getElementById('eval-tech').value,
                    capex: parseFloat(document.getElementById('eval-capex').value),
                    opex: parseFloat(document.getElementById('eval-opex').value),
                    price: parseFloat(document.getElementById('eval-price').value),
                    period: parseInt(document.getElementById('eval-period').value),
                    discount: parseFloat(document.getElementById('eval-discount').value),
                    production: parseFloat(document.getElementById('eval-production').value)
                };
                const index = projects.findIndex(p => p.id === currentEvalProject);
                if (index > -1) {
                    projects[index] = projectData;
                } else {
                    projects.push(projectData);
                }
                safeStorage.setItem('evalProjects', JSON.stringify(projects));
                loadEvalProjects();
                document.getElementById('eval-form').reset();
                document.getElementById('eval-results').innerHTML = '<div class="success-message"><i class="fas fa-check-circle"></i> Proyecto guardado exitosamente</div>';
                if (cashflowChart) {
                    cashflowChart.destroy();
                    cashflowChart = null;
                }
                currentEvalProject = null;
                setTimeout(() => {
                    document.getElementById('eval-results').innerHTML = '<p>Completa el formulario y haz clic en "Evaluar" para ver los resultados.</p>';
                }, 3000);
            } catch (e) {
                console.error('Error saving eval project:', e);
                document.getElementById('eval-results').innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Error al guardar el proyecto</div>';
            }
        }
        function editEvalProject() {
            try {
                if (!currentEvalProject) throw new Error('No project selected');
                saveEvalProject();
            } catch (e) {
                console.error('Error editing eval project:', e);
                document.getElementById('eval-results').innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Selecciona un proyecto para editar</div>';
            }
        }
        function deleteEvalProject() {
            try {
                if (!currentEvalProject) throw new Error('No project selected');
                if (!confirm('¿Estás seguro de que deseas eliminar este proyecto?')) return;
                let projects = JSON.parse(safeStorage.getItem('evalProjects') || '[]');
                projects = projects.filter(p => p.id !== currentEvalProject);
                safeStorage.setItem('evalProjects', JSON.stringify(projects));
                loadEvalProjects();
                document.getElementById('eval-form').reset();
                document.getElementById('eval-results').innerHTML = '<div class="success-message"><i class="fas fa-check-circle"></i> Proyecto eliminado exitosamente</div>';
                if (cashflowChart) {
                    cashflowChart.destroy();
                    cashflowChart = null;
                }
                currentEvalProject = null;
                setTimeout(() => {
                    document.getElementById('eval-results').innerHTML = '<p>Completa el formulario y haz clic en "Evaluar" para ver los resultados.</p>';
                }, 3000);
            } catch (e) {
                console.error('Error deleting eval project:', e);
                document.getElementById('eval-results').innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i> Error al eliminar el proyecto</div>';
            }
        }
        // Control Functions
        function loadControlProjects() {
            try {
                const projects = JSON.parse(safeStorage.getItem('controlProjects') || '[]');
                const list = document.getElementById('control-project-list');
                if (!list) throw new Error('Control project list not found');
                list.innerHTML = '';
                projects.forEach(project => {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="fas fa-project-diagram"></i> ${project.name || 'Proyecto sin nombre'}`;
                    li.onclick = () => selectControlProject(project);
                    if (project.id === currentControlProject) li.classList.add('active');
                    list.appendChild(li);
                });
            } catch (e) {
                console.error('Error loading control projects:', e);
                document.getElementById('control-project-list').innerHTML = '<li class="error-message"><i class="fas fa-exclamation-triangle"></i> Error al cargar proyectos</li>';
            }
        }
        function selectControlProject(project) {
            try {
                if (!project) throw new Error('Invalid project selected');
                currentControlProject = project.id;
                document.querySelectorAll('#control-project-list li').forEach(li => li.classList.remove('active'));
                const selectedLi = Array.from(document.querySelectorAll('#control-project-list li')).find(li => li.textContent.includes(project.name));
                if (selectedLi) selectedLi.classList.add('active');
                document.getElementById('control-project-name').value = project.name || '';
                document.getElementById('control-start-date').value = project.startDate || '';
                document.getElementById('terreno-progress').value = project.terreno?.progress || '0';
                document.getElementById('terreno-start').value = project.terreno?.start || '';
                document.getElementById('terreno-end').value = project.terreno?.end || '';
                document.getElementById('terreno-comments').value = project.terreno?.comments || '';
                document.getElementById('conexion-progress').value = project.conexion?.progress || '0';
                document.getElementById('conexion-start').value = project.conexion?.start || '';
                document.getElementById('conexion-end').value = project.conexion?.end || '';
                document.getElementById('conexion-comments').value = project.conexion?.comments || '';
                document.getElementById('linea-progress').value = project.linea?.progress || '0';
                document.getElementById('linea-start').value = project.linea?.start || '';
                document.getElementById('linea-end').value = project.linea?.end || '';
                document.getElementById('linea-comments').value = project.linea?.comments || '';
                document.getElementById('permiso-progress').value = project.permiso?.progress || '0';
                document.getElementById('permiso-start').value = project.permiso?.start || '';
                document.getElementById('permiso-end').value = project.permiso?.end || '';
                document.getElementById('permiso-comments').value = project.permiso?.comments || '';
                document.getElementById('comunidades-progress').value = project.comunidades?.progress || '0';
                document.getElementById('comunidades-start').value = project.comunidades?.start || '';
                document.getElementById('comunidades-end').value = project.comunidades?.end || '';
                document.getElementById('comunidades-comments').value = project.comunidades?.comments || '';
                document.querySelectorAll('.progress-fill').forEach(bar => {
                    const id = bar.id.replace('-progress-bar', '');
                    const value = document.getElementById(`${id}-progress`).value;
                    bar.style.width = `${value || 0}%`;
                });
                updateGanttChart();
            } catch (e) {
                console.error('Error selecting control project:', e);
                alert('Error al seleccionar el proyecto');
            }
        }
        function validateControlForm() {
            try {
                const name = document.getElementById('control-project-name').value;
                if (!name) {
                    alert('El nombre del proyecto es requerido');
                    return false;
                }
                const milestones = ['terreno', 'conexion', 'linea', 'permiso', 'comunidades'];
                for (const m of milestones) {
                    const progress = document.getElementById(`${m}-progress`).value;
                    const start = document.getElementById(`${m}-start`).value;
                    const end = document.getElementById(`${m}-end`).value;
                    if (progress && (isNaN(progress) || progress < 0 || progress > 100)) {
                        alert(`El porcentaje de avance de ${m} debe estar entre 0 y 100`);
                        return false;
                    }
                    if ((start || end) && (!start || !end)) {
                        alert(`Debes ingresar ambas fechas para ${m}`);
                        return false;
                    }
                    if (start && end && new Date(start) > new Date(end)) {
                        alert(`La fecha de término de ${m} debe ser posterior a la de inicio`);
                        return false;
                    }
                }
                return true;
            } catch (e) {
                console.error('Error validating control form:', e);
                alert('Error al validar el formulario');
                return false;
            }
        }
        function updateProgress(area, value) {
            try {
                if (isNaN(value) || value < 0 || value > 100) return;
                const progressBar = document.getElementById(`${area}-progress-bar`);
                if (progressBar) progressBar.style.width = `${value}%`;
                updateGanttChart();
            } catch (e) {
                console.error('Error updating progress:', e);
            }
        }
        function updateGanttChart() {
            try {
                const ganttChart = document.getElementById('gantt-chart');
                const ganttLabels = document.getElementById('gantt-labels');
                if (!ganttChart || !ganttLabels) throw new Error('Gantt chart or labels container not found');
                ganttChart.innerHTML = '';
                ganttLabels.innerHTML = '';
                const startDate = document.getElementById('control-start-date').valueAsDate;
                if (!startDate) {
                    ganttChart.innerHTML = '<p class="error-message"><i class="fas fa-exclamation-triangle"></i> Por favor, selecciona una fecha de inicio del proyecto</p>';
                    return;
                }
                const tasks = [
                    { 
                        name: 'Terreno', 
                        start: document.getElementById('terreno-start').valueAsDate || new Date(startDate),
                        end: document.getElementById('terreno-end').valueAsDate || new Date(startDate.getTime() + 30 * 24 * 60 * 60 * 1000),
                        progress: parseFloat(document.getElementById('terreno-progress').value) || 0
                    },
                    { 
                        name: 'Conexión', 
                        start: document.getElementById('conexion-start').valueAsDate || new Date(startDate.getTime() + 30 * 24 * 60 * 60 * 1000),
                        end: document.getElementById('conexion-end').valueAsDate || new Date(startDate.getTime() + 60 * 24 * 60 * 60 * 1000),
                        progress: parseFloat(document.getElementById('conexion-progress').value) || 0
                    },
                    { 
                        name: 'Línea', 
                        start: document.getElementById('linea-start').valueAsDate || new Date(startDate.getTime() + 60 * 24 * 60 * 60 * 1000),
                        end: document.getElementById('linea-end').valueAsDate || new Date(startDate.getTime() + 90 * 24 * 60 * 60 * 1000),
                        progress: parseFloat(document.getElementById('linea-progress').value) || 0
                    },
                    { 
                        name: 'Permiso Ambiental', 
                        start: document.getElementById('permiso-start').valueAsDate || new Date(startDate),
                        end: document.getElementById('permiso-end').valueAsDate || new Date(startDate.getTime() + 30 * 24 * 60 * 60 * 1000),
                        progress: parseFloat(document.getElementById('permiso-progress').value) || 0
                    },
                    { 
                        name: 'Comunidades', 
                        start: document.getElementById('comunidades-start').valueAsDate || new Date(startDate.getTime() + 30 * 24 * 60 * 60 * 1000),
                        end: document.getElementById('comunidades-end').valueAsDate || new Date(startDate.getTime() + 60 * 24 * 60 * 60 * 1000),
                        progress: parseFloat(document.getElementById('comunidades-progress').value) || 0
                    }
                ];
                const validTasks = tasks.filter(task => task.start && task.end && !isNaN(task.start.getTime()) && !isNaN(task.end.getTime()) && task.start <= task.end);
                if (validTasks.length === 0) {
                    ganttChart.innerHTML = '<p class="error-message"><i class="fas fa-exclamation-triangle"></i> No hay hitos válidos con fechas completas para mostrar</p>';
                    return;
                }
                // Calculate total task for project duration and average progress
                const minDate = new Date(Math.min(...validTasks.map(task => task.start.getTime())));
                const maxDate = new Date(Math.max(...validTasks.map(task => task.end.getTime())));
                const averageProgress = validTasks.reduce((sum, task) => sum + task.progress, 0) / validTasks.length;
                validTasks.push({
                    name: 'Total',
                    start: minDate,
                    end: maxDate,
                    progress: averageProgress
                });
                // Adjust date range
                const startDateAdjusted = new Date(minDate);
                startDateAdjusted.setMonth(startDateAdjusted.getMonth() - 1);
                const endDateAdjusted = new Date(maxDate);
                endDateAdjusted.setMonth(endDateAdjusted.getMonth() + 1);
                const totalDays = Math.ceil((endDateAdjusted - startDateAdjusted) / (1000 * 60 * 60 * 24));
                if (totalDays <= 0) {
                    ganttChart.innerHTML = '<p class="error-message"><i class="fas fa-exclamation-triangle"></i> Rango de fechas inválido</p>';
                    return;
                }
                const dayWidth = ganttChart.offsetWidth / totalDays;
                // Create y-axis labels
                validTasks.forEach((task, index) => {
                    const label = document.createElement('div');
                    label.className = 'gantt-label';
                    label.style.top = `${index * 40 + 10}px`;
                    label.innerHTML = `<i class="fas ${getIconForTask(task.name)}"></i> ${task.name}`;
                    ganttLabels.appendChild(label);
                });
                // Create task bars and progress bars
                validTasks.forEach((task, index) => {
                    const daysFromStart = Math.ceil((task.start - startDateAdjusted) / (1000 * 60 * 60 * 24));
                    const taskDuration = Math.ceil((task.end - task.start) / (1000 * 60 * 60 * 24));
                    if (taskDuration <= 0) return;
                    const taskElement = document.createElement('div');
                    taskElement.className = `gantt-item ${task.name === 'Total' ? 'total' : ''}`;
                    taskElement.style.left = `${daysFromStart * dayWidth}px`;
                    taskElement.style.width = `${taskDuration * dayWidth}px`;
                    taskElement.style.top = `${index * 40 + 10}px`;
                    // --- MEJORA 1: Tooltip Enriquecido ---
                    const durationDays = Math.ceil((task.end - task.start) / (1000 * 60 * 60 * 24));
                    taskElement.title = `${task.name}\nInicio: ${task.start.toLocaleDateString('es-ES')}\nTérmino: ${task.end.toLocaleDateString('es-ES')}\nDuración: ${durationDays} días\nProgreso: ${task.progress}%`;
                    // --- MEJORA 6: Interactividad de Selección ---
                    taskElement.onclick = () => {
                        document.querySelectorAll('.gantt-item').forEach(item => item.classList.remove('active'));
                        taskElement.classList.add('active');
                    };
                    // --- MEJORA 2 & 3: Barra de progreso con etiqueta en negrita y color azul ---
                    const progressElement = document.createElement('div');
                    progressElement.className = 'gantt-progress';
                    progressElement.style.width = `${task.progress}%`;
                    // Etiqueta de porcentaje en negrita
                    const progressLabel = document.createElement('span');
                    progressLabel.className = 'gantt-progress-label';
                    progressLabel.textContent = `${Math.round(task.progress)}%`;
                    progressElement.appendChild(progressLabel);
                    taskElement.appendChild(progressElement);
                    ganttChart.appendChild(taskElement);
                });
                // --- MEJORA 5: Escala de Tiempo Adaptativa ---
                let step = 30;
                if (totalDays < 60) step = 7;
                else if (totalDays < 120) step = 14;
                for (let i = 0; i <= totalDays; i += step) {
                    const timeMarker = document.createElement('div');
                    timeMarker.style.position = 'absolute';
                    timeMarker.style.left = `${i * dayWidth}px`;
                    timeMarker.style.top = '0';
                    timeMarker.style.width = '1px';
                    timeMarker.style.height = '100%';
                    timeMarker.style.backgroundColor = '#e9ecef';
                    timeMarker.style.zIndex = '1';
                    ganttChart.appendChild(timeMarker);
                    const dateLabel = document.createElement('div');
                    dateLabel.style.position = 'absolute';
                    dateLabel.style.left = `${i * dayWidth}px`;
                    dateLabel.style.top = '-25px';
                    dateLabel.style.fontSize = '12px';
                    dateLabel.style.color = '#6c757d';
                    dateLabel.style.fontWeight = '500';
                    dateLabel.style.transform = 'translateX(-50%)';
                    dateLabel.style.whiteSpace = 'nowrap';
                    const currentDate = new Date(startDateAdjusted);
                    currentDate.setDate(startDateAdjusted.getDate() + i);
                    // --- MEJORA 4: Formato "mar 25" ---
                    dateLabel.textContent = currentDate.toLocaleDateString('es-ES', { month: 'short', year: '2-digit' }).replace('.', '');
                    ganttChart.appendChild(dateLabel);
                }
                // --- Línea de Tiempo "Hoy" ---
                const today = new Date();
                if (today >= startDateAdjusted && today <= endDateAdjusted) {
                    const daysFromStartToday = Math.ceil((today - startDateAdjusted) / (1000 * 60 * 60 * 24));
                    const todayLine = document.createElement('div');
                    todayLine.className = 'gantt-today-line';
                    todayLine.style.left = `${daysFromStartToday * dayWidth}px`;
                    todayLine.title = `Hoy: ${today.toLocaleDateString('es-ES')}`;
                    ganttChart.appendChild(todayLine);
                }
            } catch (e) {
                console.error('Error drawing Gantt chart:', e);
                document.getElementById('gantt-chart').innerHTML = `<p class="error-message"><i class="fas fa-exclamation-triangle"></i> Error al dibujar el diagrama de Gantt: ${e.message}</p>`;
            }
        }
        function getIconForTask(taskName) {
            const icons = {
                'Terreno': 'fa-landmark',
                'Conexión': 'fa-plug',
                'Línea': 'fa-route',
                'Permiso Ambiental': 'fa-tree',
                'Comunidades': 'fa-users',
                'Total': 'fa-chart-line'
            };
            return icons[taskName] || 'fa-tasks';
        }
        function addNewControlProject() {
            try {
                const list = document.getElementById('control-project-list');
                const newProject = {
                    id: Date.now(),
                    name: `Nuevo Proyecto ${list.children.length + 1}`,
                    startDate: new Date().toISOString().split('T')[0],
                    terreno: { progress: '0', start: '', end: '', comments: '' },
                    conexion: { progress: '0', start: '', end: '', comments: '' },
                    linea: { progress: '0', start: '', end: '', comments: '' },
                    permiso: { progress: '0', start: '', end: '', comments: '' },
                    comunidades: { progress: '0', start: '', end: '', comments: '' }
                };
                const projects = JSON.parse(safeStorage.getItem('controlProjects') || '[]');
                projects.push(newProject);
                safeStorage.setItem('controlProjects', JSON.stringify(projects));
                loadControlProjects();
                selectControlProject(newProject);
                // Show success message
                const formContainer = document.querySelector('.form-container');
                const successMsg = document.createElement('div');
                successMsg.className = 'success-message';
                successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Nuevo proyecto creado. Completa los datos y guarda.';
                formContainer.prepend(successMsg);
                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.remove();
                    }
                }, 5000);
            } catch (e) {
                console.error('Error adding new control project:', e);
                alert('Error al añadir nuevo proyecto');
            }
        }
        function saveControlProject() {
            if (!validateControlForm()) return;
            try {
                const projects = JSON.parse(safeStorage.getItem('controlProjects') || '[]');
                const name = document.getElementById('control-project-name').value;
                const projectData = {
                    id: currentControlProject || Date.now(),
                    name,
                    startDate: document.getElementById('control-start-date').value,
                    terreno: {
                        progress: document.getElementById('terreno-progress').value,
                        start: document.getElementById('terreno-start').value,
                        end: document.getElementById('terreno-end').value,
                        comments: document.getElementById('terreno-comments').value
                    },
                    conexion: {
                        progress: document.getElementById('conexion-progress').value,
                        start: document.getElementById('conexion-start').value,
                        end: document.getElementById('conexion-end').value,
                        comments: document.getElementById('conexion-comments').value
                    },
                    linea: {
                        progress: document.getElementById('linea-progress').value,
                        start: document.getElementById('linea-start').value,
                        end: document.getElementById('linea-end').value,
                        comments: document.getElementById('linea-comments').value
                    },
                    permiso: {
                        progress: document.getElementById('permiso-progress').value,
                        start: document.getElementById('permiso-start').value,
                        end: document.getElementById('permiso-end').value,
                        comments: document.getElementById('permiso-comments').value
                    },
                    comunidades: {
                        progress: document.getElementById('comunidades-progress').value,
                        start: document.getElementById('comunidades-start').value,
                        end: document.getElementById('comunidades-end').value,
                        comments: document.getElementById('comunidades-comments').value
                    }
                };
                const index = projects.findIndex(p => p.id === currentControlProject);
                if (index > -1) {
                    projects[index] = projectData;
                } else {
                    projects.push(projectData);
                }
                safeStorage.setItem('controlProjects', JSON.stringify(projects));
                loadControlProjects();
                // Show success message
                const formContainer = document.querySelector('.form-container');
                const successMsg = document.createElement('div');
                successMsg.className = 'success-message';
                successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Proyecto guardado exitosamente';
                formContainer.prepend(successMsg);
                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.remove();
                    }
                }, 3000);
                currentControlProject = null;
                updateGanttChart();
            } catch (e) {
                console.error('Error saving control project:', e);
                alert('Error al guardar el proyecto');
            }
        }
        function editControlProject() {
            try {
                if (!currentControlProject) throw new Error('No project selected');
                saveControlProject();
            } catch (e) {
                console.error('Error editing control project:', e);
                alert('Selecciona un proyecto para editar');
            }
        }
        function deleteControlProject() {
            try {
                if (!currentControlProject) throw new Error('No project selected');
                if (!confirm('¿Estás seguro de que deseas eliminar este proyecto?')) return;
                let projects = JSON.parse(safeStorage.getItem('controlProjects') || '[]');
                projects = projects.filter(p => p.id !== currentControlProject);
                safeStorage.setItem('controlProjects', JSON.stringify(projects));
                loadControlProjects();
                // Show success message
                const formContainer = document.querySelector('.form-container');
                const successMsg = document.createElement('div');
                successMsg.className = 'success-message';
                successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Proyecto eliminado exitosamente';
                formContainer.prepend(successMsg);
                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.remove();
                    }
                }, 3000);
                document.getElementById('control-project-name').value = '';
                document.getElementById('control-start-date').value = '';
                document.querySelectorAll('.progress-item input[type="number"]').forEach(input => input.value = '0');
                document.querySelectorAll('.progress-item input[type="date"]').forEach(input => input.value = '');
                document.querySelectorAll('.control-table textarea').forEach(textarea => textarea.value = '');
                document.querySelectorAll('.progress-fill').forEach(bar => bar.style.width = '0%');
                currentControlProject = null;
                updateGanttChart();
            } catch (e) {
                console.error('Error deleting control project:', e);
                alert('Error al eliminar el proyecto');
            }
        }
        // Event Listeners
        try {
            document.getElementById('contact-form')?.addEventListener('submit', e => {
                e.preventDefault();
                const successMsg = document.createElement('div');
                successMsg.className = 'success-message';
                successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Mensaje enviado exitosamente. Nos pondremos en contacto contigo pronto.';
                e.target.parentNode.insertBefore(successMsg, e.target.nextSibling);
                e.target.reset();
                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.remove();
                    }
                }, 5000);
            });
            document.addEventListener('DOMContentLoaded', () => {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('control-start-date').value = today;
                loadEvalProjects();
                loadControlProjects();
                updateGanttChart();
            });
            window.addEventListener('resize', () => {
                if (document.getElementById('control').classList.contains('active')) {
                    updateGanttChart();
                }
            });
        } catch (e) {
            console.error('Error setting event listeners:', e);
            alert('Error al inicializar los eventos');
        }
    </script>
</body>
</html>
